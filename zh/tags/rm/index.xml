<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Rm on 人生删除指南</title><link>https://liguobao.github.io/zh/tags/rm/</link><description>Recent content in Rm on 人生删除指南</description><generator>Hugo -- gohugo.io</generator><language>zh</language><lastBuildDate>Tue, 20 Nov 2018 00:00:00 +0000</lastBuildDate><atom:link href="https://liguobao.github.io/zh/tags/rm/index.xml" rel="self" type="application/rss+xml"/><item><title>没有执行过rm -rf /*的开发不是好运维</title><link>https://liguobao.github.io/zh/p/%E6%B2%A1%E6%9C%89%E6%89%A7%E8%A1%8C%E8%BF%87rm-rf-/%E7%9A%84%E5%BC%80%E5%8F%91%E4%B8%8D%E6%98%AF%E5%A5%BD%E8%BF%90%E7%BB%B4/</link><pubDate>Tue, 20 Nov 2018 00:00:00 +0000</pubDate><guid>https://liguobao.github.io/zh/p/%E6%B2%A1%E6%9C%89%E6%89%A7%E8%A1%8C%E8%BF%87rm-rf-/%E7%9A%84%E5%BC%80%E5%8F%91%E4%B8%8D%E6%98%AF%E5%A5%BD%E8%BF%90%E7%BB%B4/</guid><description>&lt;h1 id="没有执行过rm--rf-的开发不是好运维"&gt;没有执行过rm -rf /*的开发不是好运维
&lt;/h1&gt;&lt;h2 id="起因"&gt;起因
&lt;/h2&gt;&lt;p&gt;突然收到用户反馈说网站在手机端打开是白屏, 很奇怪的问题.&lt;/p&gt;
&lt;p&gt;在电脑端试了下,确实也是白屏,HTML加载进来了,好像有个核心JS加载失败.&lt;/p&gt;
&lt;p&gt;看到一个错误是: We&amp;rsquo;re sorry but house doesn&amp;rsquo;t work properly without JavaScript enabled. Please enable it to continue.&lt;/p&gt;
&lt;p&gt;还有一个http请求的错误是: ERR_INCOMPLETE_CHUNKED_ENCODING&lt;/p&gt;
&lt;p&gt;&lt;img src="https://ws1.sinaimg.cn/large/64d1e863gy1fxk2pfnj1tj22lc10igrm.jpg"
loading="lazy"
&gt;&lt;/p&gt;
&lt;p&gt;于是尝试了一下的解决方案:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;无脑重启看看能不能解决问题?重启了一下对应Docker容器,无果&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;可能是现在版本引入的Bug?回滚代码重新build,无果.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;nginx的问题? 重启nginx,无果.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;查看nginx日志,没什么有用的东西,无果.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;灵机一闪,不会是磁盘空间满了吧.&lt;/p&gt;
&lt;p&gt;df -h 看了一眼,99.99%的磁盘使用率.&lt;/p&gt;
&lt;p&gt;某个Docker容器的磁盘空间用掉了34G.&lt;/p&gt;
&lt;p&gt;看一眼Docker容器,直觉告诉我应该是Elasticsearch服务&amp;hellip;&lt;/p&gt;
&lt;p&gt;不算太重要的服务,先停了清理空间再说.&lt;/p&gt;
&lt;p&gt;删掉了容器删了data文件,重启nginx,一切都正常Work了.&lt;/p&gt;
&lt;p&gt;问题解决!!!&lt;/p&gt;
&lt;p&gt;不过Elasticsearch总要重新回复回来嘛,看了下腾讯云云硬盘盘价格,也不是很贵嘛.&lt;/p&gt;
&lt;p&gt;单独给Elasticsearch 起个数据盘吧.&lt;/p&gt;
&lt;h2 id="作死开始"&gt;作死开始
&lt;/h2&gt;&lt;p&gt;首先根据腾讯云的指示,挂在了数据盘到服务器上面.&lt;/p&gt;
&lt;p&gt;然后给数据盘分区,接着mount到对应的路径.&lt;/p&gt;
&lt;p&gt;嗯,好像有个警告.&lt;/p&gt;
&lt;p&gt;难道不是这个磁盘么?换另外一个看看.&lt;/p&gt;
&lt;p&gt;执行另外一个mount.&lt;/p&gt;
&lt;p&gt;全程命令如下:&lt;/p&gt;
&lt;p&gt;&lt;img src="https://ws1.sinaimg.cn/large/64d1e863gy1fxk3f86li1j220613mkho.jpg"
loading="lazy"
&gt;&lt;/p&gt;
&lt;p&gt;进入对应目录清空一下云盘数据吧.(PS:脑子有病才做这个,刚刚初始化的云盘哪有东西.)&lt;/p&gt;
&lt;p&gt;ls 看一下,咋这么多奇奇怪怪的文件,难道是原来Elasticsearch docker 容器留下来的.&lt;/p&gt;
&lt;p&gt;先删了再说.&lt;/p&gt;
&lt;p&gt;执行 rm -rf ./*&lt;/p&gt;
&lt;p&gt;咦,怎么有文件busy无法删除.&lt;/p&gt;
&lt;p&gt;额,咋ls都没有了.&lt;/p&gt;
&lt;p&gt;哈?cat 也没有了.&lt;/p&gt;
&lt;p&gt;噗,copy也炸了.&lt;/p&gt;
&lt;p&gt;cd 还在.&lt;/p&gt;
&lt;p&gt;哇卡,这可咋办了.&lt;/p&gt;
&lt;h2 id="先复盘一下做了什么事情"&gt;先复盘一下做了什么事情
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;初始化磁盘的时候没有格式化,但是mount失败&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;mount失败后没有检查原因,直接尝试把另一个磁盘mount进去&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;mount系统盘到指定文件夹后并没有检查内容,直接rm -rf ./*&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;rm -rf ./* 此时已经基本没救了&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="拯救尝试"&gt;拯救尝试
&lt;/h2&gt;&lt;p&gt;还在跑的服务基本是活着的，所以暂时来说API和Web网站都是好的。&lt;/p&gt;
&lt;p&gt;服务器上面跑的基本都是Docker容器, Docker镜像都在阿里云上面存着，基本不怕丢失的问题。&lt;/p&gt;
&lt;p&gt;不过应用配置文件/服务器证书之类的东西都在上面，这个估计要折腾一下了。&lt;/p&gt;
&lt;p&gt;cd 还能用，ls没了，cat也没了。&lt;/p&gt;
&lt;p&gt;尝试cat xxx.conf也没用了,难道只能一点点翻配置文件么.&lt;/p&gt;
&lt;p&gt;群里的朋友提了一句，看看你的云盘有没有备份之类的.&lt;/p&gt;
&lt;p&gt;咦,好像两个星期前找腾讯云技术支持的时候做过一次系统镜像.&lt;/p&gt;
&lt;p&gt;是不是可以直接拿回来直接用?&lt;/p&gt;
&lt;p&gt;看了下具体的镜像版本和备注信息,看起来那时候上面的内容和现在的估计没太多变化.&lt;/p&gt;
&lt;p&gt;直接重装之后更新一下各个服务的镜像到最新版本应该就好了.&lt;/p&gt;
&lt;h2 id="放弃拯救直接使用备份的系统镜像重装"&gt;放弃拯救,直接使用备份的系统镜像重装
&lt;/h2&gt;&lt;p&gt;Work&amp;hellip;&lt;/p&gt;
&lt;p&gt;系统备份镜像拯救世界!!!&lt;/p&gt;
&lt;h2 id="后续操作--总结"&gt;后续操作 + 总结
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;数据盘和系统盘分开,不要让程序的数据导致系统不可用&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;在费用允许的情况下设置磁盘快照策略,我这边最极端的情况下也应该能回滚到一个星期前的版本&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;下次大影响操作前先手动备份系统镜像,救命稻草一般的存在.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</description></item></channel></rss>