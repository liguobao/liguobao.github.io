<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='æœ€è¿‘åœ¨æŠ˜è…¾GitLabè¿ç§»ï¼Œç”±äºåŸGitLabç‰ˆæœ¬å®åœ¨æ˜¯å¤ªä½äº†ï¼Œ\nåŒæ—¶ä½¿ç”¨çš„æ˜¯è¢«é­”æ”¹è¿‡çš„ï¼Œå®Œå…¨ä¸å¤ªå¯èƒ½ä»è€ç‰ˆæœ¬è·¨å‡ ä¸ªå¤§ç‰ˆæœ¬å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œ\næ‰€ä»¥æœ€åå†³å®šå†™Pythonè„šæœ¬è°ƒç”¨Gitlab APIå¯¼å‡ºç”¨æˆ·å’Œåˆ†ç»„ä»¥åŠé¡¹ç›®ï¼Œ\næ¥ç€é€šè¿‡Gitlab APIæ·»åŠ åˆ°æ–°çš„Gitlabä¸­ï¼Œç„¶åæŠŠæºç ä»“åº“æ•´ä¸ªæ–‡ä»¶å¤¹æ‹·è´åˆ°æ–°æœåŠ¡å™¨ï¼Œ\nä½¿ç”¨Pythonæ‰§è¡Œshellå‘½ä»¤ï¼ŒæŠŠæ‰€æœ‰çš„git è£¸ä»“åº“ æäº¤åˆ°æ–°çš„Gitlabä¸­ã€‚\nå¯¼å‡ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 import requests import json from loguru import logger from datetime import datetime # GitLab åŸŸå gitlab_domain = "gitlab.com" # GitLab é…ç½® GITLAB_URL = f&#39;https://{domain}&#39; # ä½ çš„ GitLab å®ä¾‹çš„ URL API_TOKEN = &#39;xxx&#39; # ä½ çš„ GitLab è®¿é—®ä»¤ç‰Œ # è€ç‰ˆæœ¬çš„Auth Tokenåœ¨ Header HEADERS = {&#39;PRIVATE-TOKEN&#39;: f&#39;{API_TOKEN}&#39;} # è·å–æ‰€æœ‰é¡¹ç›®çš„å‡½æ•° def get_all_projects(): url = f"{GITLAB_URL}/api/v4/projects" params = { "page": 1, # é»˜è®¤ç¬¬ä¸€é¡µ "per_page": 100 # æ¯é¡µæœ€å¤šè¿”å›100ä¸ªé¡¹ç›® } projects = [] while True: response = requests.get(url, headers=HEADERS, params=params) if response.status_code != 200: logger.error(f"Error: Unable to fetch data. Status code {response.status_code}") break data = response.json() if not data: logger.info("No more projects to fetch.") break projects.extend(data) params["page"] += 1 # è·å–ä¸‹ä¸€é¡µ logger.info(f"Fetched {len(data)} projects from page {params[&#39;page&#39;] - 1}.") return projects # æå–æ‰€éœ€çš„é¡¹ç›®æ•°æ® def extract_project_info(projects, rep_base): user_project_list = [ { &#39;name&#39;: p["name"], &#39;path_with_namespace&#39;: p["path_with_namespace"], &#39;default_branch&#39;: p["default_branch"], &#39;visibility&#39;: p["visibility"], &#39;ssh_url_to_repo&#39;: p["ssh_url_to_repo"], &#39;absolute_path&#39;: rep_base + p["ssh_url_to_repo"].replace(f&#39;git@{gitlab_domain}:&#39;, ""), &#39;new_ssh_url_to_repo&#39;: p["ssh_url_to_repo"].replace(f"git@{gitlab_domain}:", "git@127.0.0.1:"), } for p in projects ] return user_project_list # ä¿å­˜æ•°æ®åˆ°æ–‡ä»¶ def save_to_file(data, filename="old_all_projects.json"): with open(filename, "w", encoding="utf-8") as f: json.dump(data, f, indent=4, ensure_ascii=False) logger.info(f"Projects data has been saved to &#39;{filename}&#39;.") # ä¸»å‡½æ•° def main(): rep_base = "/var/opt/gitlab/git-data/back_repositories/repositories/" # ä½ è‡ªå·±çš„ä»“åº“è·¯å¾„ logger.info("Starting the project extraction process.") try: # è·å–æ‰€æœ‰é¡¹ç›® projects = get_all_projects() if not projects: logger.warning("No projects found or there was an issue fetching data.") return # æå–é¡¹ç›®ä¿¡æ¯ user_project_list = extract_project_info(projects, rep_base) # ä¿å­˜é¡¹ç›®åˆ—è¡¨åˆ°æ–‡ä»¶ save_to_file(user_project_list) logger.info("Process completed successfully.") except Exception as e: logger.error(f"An error occurred: {e}") if __name__ == "__main__": main() åˆ›å»ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 import requests import json import random import string from loguru import logger # æ–° GitLab å®ä¾‹çš„ URL å’Œä¸ªäººè®¿é—®ä»¤ç‰Œ NEW_GITLAB_URL = &#39;https://new-gitlab.com&#39; # æ–°çš„ GitLab å®ä¾‹ URL API_TOKEN = &#39;xxxx&#39; # æ–°çš„ GitLab ç®¡ç†å‘˜è®¿é—®ä»¤ç‰Œ # æ–°ç‰ˆæœ¬çš„é‰´æƒHeader ç”¨çš„ Authorization HEADERS = { &#39;Authorization&#39;: f&#39;Bearer {API_TOKEN}&#39; } # éšæœºç”Ÿæˆå¯†ç  def generate_random_password(length=12): characters = string.ascii_letters + string.digits + string.punctuation return &#39;&#39;.join(random.choice(characters) for i in range(length)) # ä» JSON æ–‡ä»¶ä¸­è¯»å–å¤‡ä»½æ•°æ® def load_backup_data(): with open("dump_gitlab_data.json", "r", encoding="utf-8") as f: return json.load(f) # åˆ›å»ºç”¨æˆ· def create_user(username, email, password): url = f"{NEW_GITLAB_URL}/api/v4/users" data = { "username": username, "name": username, "email": email, "password": password, "skip_confirmation": True, "force_random_password": True # å¼ºåˆ¶ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç  } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"User {username} created successfully.") return response.json() # è¿”å›åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ JSON except requests.RequestException as e: logger.error(f"Error creating user {username}: {e}") return None # åˆ›å»ºé¡¹ç›® def create_project(group_id, project_name): url = f"{NEW_GITLAB_URL}/api/v4/projects" data = { "name": project_name, "namespace_id": group_id, # å°†é¡¹ç›®æ”¾å…¥æŒ‡å®šçš„ç»„ "visibility": "private", "initialize_with_readme": False # é»˜è®¤åˆ›å»ºç©ºé¡¹ç›® } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"Project {project_name} created successfully in group {group_id}.") return response.json() # è¿”å›åˆ›å»ºçš„é¡¹ç›®æ•°æ® except requests.RequestException as e: logger.error(f"Error creating project {project_name} in group {group_id}: {e}") return None # åˆ›å»ºåˆ†ç»„ def create_group(group_name): url = f"{NEW_GITLAB_URL}/api/v4/groups" data = { "name": group_name, "path": group_name.lower().replace(" ", "_") # è‡ªåŠ¨ç”Ÿæˆè·¯å¾„ } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"Group {group_name} created successfully.") return response.json() # è¿”å›åŒ…å«åˆ†ç»„ä¿¡æ¯çš„ JSON except requests.RequestException as e: logger.error(f"Error creating group {group_name}: {e}") return None # æ·»åŠ ç”¨æˆ·åˆ°åˆ†ç»„å¹¶è®¾ç½®æƒé™ä¸º master def add_user_to_group(group_id, user_id, access_level=40): url = f"{NEW_GITLAB_URL}/api/v4/groups/{group_id}/members" data = { "user_id": user_id, "access_level": access_level # æƒé™è®¾ç½®ä¸º master (40) } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"User {user_id} added to group {group_id} with master access.") except requests.RequestException as e: logger.error(f"Error adding user {user_id} to group {group_id}: {e}") # å¯¼å…¥ç”¨æˆ·ã€åˆ†ç»„å’Œé¡¹ç›® def import_data(): logger.add("import_gitlab_entities.log", rotation="500 MB", compression="zip") # è¯»å–å¤‡ä»½æ•°æ® backup_data = load_backup_data() # å­˜å‚¨ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç  user_passwords = [] # åˆ›å»ºç”¨æˆ· for user in backup_data["users"]: username = user["username"] email = user["email"] password = generate_random_password() user_data = create_user(username, email, password) if user_data: user_id = user_data["id"] user_passwords.append({"username": username, "email": email, "password": password}) # åˆ›å»ºç”¨æˆ·çš„é¡¹ç›® for project in user["projects"]: project_name = project["name"] # æŸ¥æ‰¾é¡¹ç›®æ‰€å±çš„åˆ†ç»„ group_name = project["namespace"]["name"] # åˆ›å»ºé¡¹ç›®æ—¶éœ€è¦ä½¿ç”¨åˆ†ç»„IDï¼Œé¦–å…ˆè·å–åˆ†ç»„çš„ ID group_id = None for group in backup_data["groups"]: if group["name"] == group_name: group_id = create_group(group_name)["id"] break if group_id: create_project(group_id, project_name) # åˆ›å»ºé¡¹ç›®åï¼Œå°†ç”¨æˆ·æ·»åŠ åˆ°åˆ†ç»„ä¸­ add_user_to_group(group_id, user_id) # åˆ›å»ºåˆ†ç»„å’Œé¡¹ç›® for group in backup_data["groups"]: group_name = group["name"] group_data = create_group(group_name) if group_data: group_id = group_data["id"] # åˆ›å»ºåˆ†ç»„ä¸­çš„é¡¹ç›® for project in group["projects"]: project_name = project["name"] create_project(group_id, project_name) # æ·»åŠ å¯¹åº”çš„ç”¨æˆ·åˆ°åˆ†ç»„ï¼Œå¹¶è®¾ç½®ä¸º master æƒé™ for group_user in group["users"]: add_user_to_group(group_id, group_user["user_id"]) # å°†ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç ä¿å­˜åˆ° JSON æ–‡ä»¶ with open("user_passwords.json", "w", encoding="utf-8") as f: json.dump(user_passwords, f, ensure_ascii=False, indent=4) logger.info("User passwords have been exported to user_passwords.json") if __name__ == "__main__": import_data() æäº¤Git è£¸ä»“åº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 import os import subprocess import json from loguru import logger # è¯»å–é…ç½®çš„ JSON æ–‡ä»¶ def load_config(file_path): with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: return json.load(f) # å°†æ“ä½œç»“æœå†™å…¥åˆ° JSON æ–‡ä»¶ def write_result_to_json(results, output_file): with open(output_file, &#39;w+&#39;, encoding=&#39;utf-8&#39;) as f: json.dump(results, f, indent=4, ensure_ascii=False) # æ¨é€è£¸ä»“åº“åˆ°æ–°è¿œç«¯ def push_bare_repo_to_remote(project, results): absolute_path = project["absolute_path"] new_ssh_url_to_repo = project["new_ssh_url_to_repo"] # æ£€æŸ¥ä»“åº“è·¯å¾„æ˜¯å¦åˆæ³• if not os.path.isdir(absolute_path) or not os.path.exists(os.path.join(absolute_path, "HEAD")): logger.error(f"Invalid bare repository path: {absolute_path}") results.append({ "project": project, "status": "failed", "message": f"Invalid bare repository path: {absolute_path}" }) return try: # è¿›å…¥åŸå§‹ä»“åº“ç›®å½• logger.info(f"Accessing local bare repository: {absolute_path}") os.chdir(absolute_path) # ç¡®ä¿æ˜¯è£¸ä»“åº“ subprocess.run(["git", "rev-parse", "--is-bare-repository"], check=True) # è®¾ç½®æ–°çš„è¿œç«¯åœ°å€ logger.info(f"Setting new remote URL: {new_ssh_url_to_repo}") subprocess.run(["git", "remote", "add", "new-origin", new_ssh_url_to_repo], check=True) # æ¨é€æ‰€æœ‰åˆ†æ”¯åˆ°æ–°è¿œç«¯ logger.info("Pushing all branches to the new remote repository") subprocess.run(["git", "push", "new-origin", "--all","-f"], check=True) # æ¨é€æ‰€æœ‰æ ‡ç­¾åˆ°æ–°è¿œç«¯ logger.info("Pushing all tags to the new remote repository") subprocess.run(["git", "push", "new-origin", "--tags"], check=True) results.append({ "project": project, "status": "success", "message": f"Successfully pushed to {new_ssh_url_to_repo}" }) except subprocess.CalledProcessError as e: logger.error(f"Error during git operations: {e}") results.append({ "project": project, "status": "failed", "message": f"Error during git operations: {str(e)}" }) except Exception as e: logger.exception("Unexpected error occurred") results.append({ "project": project, "status": "failed", "message": f"Unexpected error: {str(e)}" }) finally: # ç§»é™¤æ–°è¿œç«¯é…ç½®ä»¥ä¿æŒåŸå§‹ä»“åº“æ¸…æ´ try: subprocess.run(["git", "remote", "remove", "new-origin"], check=True) except subprocess.CalledProcessError: logger.warning("Failed to remove new-origin remote, please check manually.") # ä¸»å‡½æ•° def main(): config_file = &#39;old_all_projects.json&#39; output_file = &#39;old_all_projects_result_2024.json&#39; projects = load_config(config_file) logger.add("all_projects_operation_log_2024.log", rotation="500 MB", level="INFO", compression="zip") results = [] for project in projects: logger.info(f"Processing project: {project[&#39;name&#39;]}") push_bare_repo_to_remote(project, results) write_result_to_json(results, output_file) logger.info(f"Operation results saved to {output_file}") if __name__ == "__main__": main() '><title>Gitlab ä½ç‰ˆæœ¬è¿ç§»ç®€æ˜“æ•™ç¨‹</title><link rel=canonical href=https://liguobao.github.io/zh/p/gitlab-migration-low-version/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Gitlab ä½ç‰ˆæœ¬è¿ç§»ç®€æ˜“æ•™ç¨‹"><meta property='og:description' content='æœ€è¿‘åœ¨æŠ˜è…¾GitLabè¿ç§»ï¼Œç”±äºåŸGitLabç‰ˆæœ¬å®åœ¨æ˜¯å¤ªä½äº†ï¼Œ\nåŒæ—¶ä½¿ç”¨çš„æ˜¯è¢«é­”æ”¹è¿‡çš„ï¼Œå®Œå…¨ä¸å¤ªå¯èƒ½ä»è€ç‰ˆæœ¬è·¨å‡ ä¸ªå¤§ç‰ˆæœ¬å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œ\næ‰€ä»¥æœ€åå†³å®šå†™Pythonè„šæœ¬è°ƒç”¨Gitlab APIå¯¼å‡ºç”¨æˆ·å’Œåˆ†ç»„ä»¥åŠé¡¹ç›®ï¼Œ\næ¥ç€é€šè¿‡Gitlab APIæ·»åŠ åˆ°æ–°çš„Gitlabä¸­ï¼Œç„¶åæŠŠæºç ä»“åº“æ•´ä¸ªæ–‡ä»¶å¤¹æ‹·è´åˆ°æ–°æœåŠ¡å™¨ï¼Œ\nä½¿ç”¨Pythonæ‰§è¡Œshellå‘½ä»¤ï¼ŒæŠŠæ‰€æœ‰çš„git è£¸ä»“åº“ æäº¤åˆ°æ–°çš„Gitlabä¸­ã€‚\nå¯¼å‡ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 import requests import json from loguru import logger from datetime import datetime # GitLab åŸŸå gitlab_domain = "gitlab.com" # GitLab é…ç½® GITLAB_URL = f&#39;https://{domain}&#39; # ä½ çš„ GitLab å®ä¾‹çš„ URL API_TOKEN = &#39;xxx&#39; # ä½ çš„ GitLab è®¿é—®ä»¤ç‰Œ # è€ç‰ˆæœ¬çš„Auth Tokenåœ¨ Header HEADERS = {&#39;PRIVATE-TOKEN&#39;: f&#39;{API_TOKEN}&#39;} # è·å–æ‰€æœ‰é¡¹ç›®çš„å‡½æ•° def get_all_projects(): url = f"{GITLAB_URL}/api/v4/projects" params = { "page": 1, # é»˜è®¤ç¬¬ä¸€é¡µ "per_page": 100 # æ¯é¡µæœ€å¤šè¿”å›100ä¸ªé¡¹ç›® } projects = [] while True: response = requests.get(url, headers=HEADERS, params=params) if response.status_code != 200: logger.error(f"Error: Unable to fetch data. Status code {response.status_code}") break data = response.json() if not data: logger.info("No more projects to fetch.") break projects.extend(data) params["page"] += 1 # è·å–ä¸‹ä¸€é¡µ logger.info(f"Fetched {len(data)} projects from page {params[&#39;page&#39;] - 1}.") return projects # æå–æ‰€éœ€çš„é¡¹ç›®æ•°æ® def extract_project_info(projects, rep_base): user_project_list = [ { &#39;name&#39;: p["name"], &#39;path_with_namespace&#39;: p["path_with_namespace"], &#39;default_branch&#39;: p["default_branch"], &#39;visibility&#39;: p["visibility"], &#39;ssh_url_to_repo&#39;: p["ssh_url_to_repo"], &#39;absolute_path&#39;: rep_base + p["ssh_url_to_repo"].replace(f&#39;git@{gitlab_domain}:&#39;, ""), &#39;new_ssh_url_to_repo&#39;: p["ssh_url_to_repo"].replace(f"git@{gitlab_domain}:", "git@127.0.0.1:"), } for p in projects ] return user_project_list # ä¿å­˜æ•°æ®åˆ°æ–‡ä»¶ def save_to_file(data, filename="old_all_projects.json"): with open(filename, "w", encoding="utf-8") as f: json.dump(data, f, indent=4, ensure_ascii=False) logger.info(f"Projects data has been saved to &#39;{filename}&#39;.") # ä¸»å‡½æ•° def main(): rep_base = "/var/opt/gitlab/git-data/back_repositories/repositories/" # ä½ è‡ªå·±çš„ä»“åº“è·¯å¾„ logger.info("Starting the project extraction process.") try: # è·å–æ‰€æœ‰é¡¹ç›® projects = get_all_projects() if not projects: logger.warning("No projects found or there was an issue fetching data.") return # æå–é¡¹ç›®ä¿¡æ¯ user_project_list = extract_project_info(projects, rep_base) # ä¿å­˜é¡¹ç›®åˆ—è¡¨åˆ°æ–‡ä»¶ save_to_file(user_project_list) logger.info("Process completed successfully.") except Exception as e: logger.error(f"An error occurred: {e}") if __name__ == "__main__": main() åˆ›å»ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 import requests import json import random import string from loguru import logger # æ–° GitLab å®ä¾‹çš„ URL å’Œä¸ªäººè®¿é—®ä»¤ç‰Œ NEW_GITLAB_URL = &#39;https://new-gitlab.com&#39; # æ–°çš„ GitLab å®ä¾‹ URL API_TOKEN = &#39;xxxx&#39; # æ–°çš„ GitLab ç®¡ç†å‘˜è®¿é—®ä»¤ç‰Œ # æ–°ç‰ˆæœ¬çš„é‰´æƒHeader ç”¨çš„ Authorization HEADERS = { &#39;Authorization&#39;: f&#39;Bearer {API_TOKEN}&#39; } # éšæœºç”Ÿæˆå¯†ç  def generate_random_password(length=12): characters = string.ascii_letters + string.digits + string.punctuation return &#39;&#39;.join(random.choice(characters) for i in range(length)) # ä» JSON æ–‡ä»¶ä¸­è¯»å–å¤‡ä»½æ•°æ® def load_backup_data(): with open("dump_gitlab_data.json", "r", encoding="utf-8") as f: return json.load(f) # åˆ›å»ºç”¨æˆ· def create_user(username, email, password): url = f"{NEW_GITLAB_URL}/api/v4/users" data = { "username": username, "name": username, "email": email, "password": password, "skip_confirmation": True, "force_random_password": True # å¼ºåˆ¶ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç  } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"User {username} created successfully.") return response.json() # è¿”å›åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ JSON except requests.RequestException as e: logger.error(f"Error creating user {username}: {e}") return None # åˆ›å»ºé¡¹ç›® def create_project(group_id, project_name): url = f"{NEW_GITLAB_URL}/api/v4/projects" data = { "name": project_name, "namespace_id": group_id, # å°†é¡¹ç›®æ”¾å…¥æŒ‡å®šçš„ç»„ "visibility": "private", "initialize_with_readme": False # é»˜è®¤åˆ›å»ºç©ºé¡¹ç›® } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"Project {project_name} created successfully in group {group_id}.") return response.json() # è¿”å›åˆ›å»ºçš„é¡¹ç›®æ•°æ® except requests.RequestException as e: logger.error(f"Error creating project {project_name} in group {group_id}: {e}") return None # åˆ›å»ºåˆ†ç»„ def create_group(group_name): url = f"{NEW_GITLAB_URL}/api/v4/groups" data = { "name": group_name, "path": group_name.lower().replace(" ", "_") # è‡ªåŠ¨ç”Ÿæˆè·¯å¾„ } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"Group {group_name} created successfully.") return response.json() # è¿”å›åŒ…å«åˆ†ç»„ä¿¡æ¯çš„ JSON except requests.RequestException as e: logger.error(f"Error creating group {group_name}: {e}") return None # æ·»åŠ ç”¨æˆ·åˆ°åˆ†ç»„å¹¶è®¾ç½®æƒé™ä¸º master def add_user_to_group(group_id, user_id, access_level=40): url = f"{NEW_GITLAB_URL}/api/v4/groups/{group_id}/members" data = { "user_id": user_id, "access_level": access_level # æƒé™è®¾ç½®ä¸º master (40) } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"User {user_id} added to group {group_id} with master access.") except requests.RequestException as e: logger.error(f"Error adding user {user_id} to group {group_id}: {e}") # å¯¼å…¥ç”¨æˆ·ã€åˆ†ç»„å’Œé¡¹ç›® def import_data(): logger.add("import_gitlab_entities.log", rotation="500 MB", compression="zip") # è¯»å–å¤‡ä»½æ•°æ® backup_data = load_backup_data() # å­˜å‚¨ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç  user_passwords = [] # åˆ›å»ºç”¨æˆ· for user in backup_data["users"]: username = user["username"] email = user["email"] password = generate_random_password() user_data = create_user(username, email, password) if user_data: user_id = user_data["id"] user_passwords.append({"username": username, "email": email, "password": password}) # åˆ›å»ºç”¨æˆ·çš„é¡¹ç›® for project in user["projects"]: project_name = project["name"] # æŸ¥æ‰¾é¡¹ç›®æ‰€å±çš„åˆ†ç»„ group_name = project["namespace"]["name"] # åˆ›å»ºé¡¹ç›®æ—¶éœ€è¦ä½¿ç”¨åˆ†ç»„IDï¼Œé¦–å…ˆè·å–åˆ†ç»„çš„ ID group_id = None for group in backup_data["groups"]: if group["name"] == group_name: group_id = create_group(group_name)["id"] break if group_id: create_project(group_id, project_name) # åˆ›å»ºé¡¹ç›®åï¼Œå°†ç”¨æˆ·æ·»åŠ åˆ°åˆ†ç»„ä¸­ add_user_to_group(group_id, user_id) # åˆ›å»ºåˆ†ç»„å’Œé¡¹ç›® for group in backup_data["groups"]: group_name = group["name"] group_data = create_group(group_name) if group_data: group_id = group_data["id"] # åˆ›å»ºåˆ†ç»„ä¸­çš„é¡¹ç›® for project in group["projects"]: project_name = project["name"] create_project(group_id, project_name) # æ·»åŠ å¯¹åº”çš„ç”¨æˆ·åˆ°åˆ†ç»„ï¼Œå¹¶è®¾ç½®ä¸º master æƒé™ for group_user in group["users"]: add_user_to_group(group_id, group_user["user_id"]) # å°†ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç ä¿å­˜åˆ° JSON æ–‡ä»¶ with open("user_passwords.json", "w", encoding="utf-8") as f: json.dump(user_passwords, f, ensure_ascii=False, indent=4) logger.info("User passwords have been exported to user_passwords.json") if __name__ == "__main__": import_data() æäº¤Git è£¸ä»“åº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 import os import subprocess import json from loguru import logger # è¯»å–é…ç½®çš„ JSON æ–‡ä»¶ def load_config(file_path): with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: return json.load(f) # å°†æ“ä½œç»“æœå†™å…¥åˆ° JSON æ–‡ä»¶ def write_result_to_json(results, output_file): with open(output_file, &#39;w+&#39;, encoding=&#39;utf-8&#39;) as f: json.dump(results, f, indent=4, ensure_ascii=False) # æ¨é€è£¸ä»“åº“åˆ°æ–°è¿œç«¯ def push_bare_repo_to_remote(project, results): absolute_path = project["absolute_path"] new_ssh_url_to_repo = project["new_ssh_url_to_repo"] # æ£€æŸ¥ä»“åº“è·¯å¾„æ˜¯å¦åˆæ³• if not os.path.isdir(absolute_path) or not os.path.exists(os.path.join(absolute_path, "HEAD")): logger.error(f"Invalid bare repository path: {absolute_path}") results.append({ "project": project, "status": "failed", "message": f"Invalid bare repository path: {absolute_path}" }) return try: # è¿›å…¥åŸå§‹ä»“åº“ç›®å½• logger.info(f"Accessing local bare repository: {absolute_path}") os.chdir(absolute_path) # ç¡®ä¿æ˜¯è£¸ä»“åº“ subprocess.run(["git", "rev-parse", "--is-bare-repository"], check=True) # è®¾ç½®æ–°çš„è¿œç«¯åœ°å€ logger.info(f"Setting new remote URL: {new_ssh_url_to_repo}") subprocess.run(["git", "remote", "add", "new-origin", new_ssh_url_to_repo], check=True) # æ¨é€æ‰€æœ‰åˆ†æ”¯åˆ°æ–°è¿œç«¯ logger.info("Pushing all branches to the new remote repository") subprocess.run(["git", "push", "new-origin", "--all","-f"], check=True) # æ¨é€æ‰€æœ‰æ ‡ç­¾åˆ°æ–°è¿œç«¯ logger.info("Pushing all tags to the new remote repository") subprocess.run(["git", "push", "new-origin", "--tags"], check=True) results.append({ "project": project, "status": "success", "message": f"Successfully pushed to {new_ssh_url_to_repo}" }) except subprocess.CalledProcessError as e: logger.error(f"Error during git operations: {e}") results.append({ "project": project, "status": "failed", "message": f"Error during git operations: {str(e)}" }) except Exception as e: logger.exception("Unexpected error occurred") results.append({ "project": project, "status": "failed", "message": f"Unexpected error: {str(e)}" }) finally: # ç§»é™¤æ–°è¿œç«¯é…ç½®ä»¥ä¿æŒåŸå§‹ä»“åº“æ¸…æ´ try: subprocess.run(["git", "remote", "remove", "new-origin"], check=True) except subprocess.CalledProcessError: logger.warning("Failed to remove new-origin remote, please check manually.") # ä¸»å‡½æ•° def main(): config_file = &#39;old_all_projects.json&#39; output_file = &#39;old_all_projects_result_2024.json&#39; projects = load_config(config_file) logger.add("all_projects_operation_log_2024.log", rotation="500 MB", level="INFO", compression="zip") results = [] for project in projects: logger.info(f"Processing project: {project[&#39;name&#39;]}") push_bare_repo_to_remote(project, results) write_result_to_json(results, output_file) logger.info(f"Operation results saved to {output_file}") if __name__ == "__main__": main() '><meta property='og:url' content='https://liguobao.github.io/zh/p/gitlab-migration-low-version/'><meta property='og:site_name' content='äººç”Ÿåˆ é™¤æŒ‡å—'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='linux'><meta property='article:tag' content='Git'><meta property='article:tag' content='Gitlab'><meta property='article:published_time' content='2024-11-25T08:00:00+00:00'><meta property='article:modified_time' content='2024-11-25T08:00:00+00:00'><meta name=twitter:title content="Gitlab ä½ç‰ˆæœ¬è¿ç§»ç®€æ˜“æ•™ç¨‹"><meta name=twitter:description content='æœ€è¿‘åœ¨æŠ˜è…¾GitLabè¿ç§»ï¼Œç”±äºåŸGitLabç‰ˆæœ¬å®åœ¨æ˜¯å¤ªä½äº†ï¼Œ\nåŒæ—¶ä½¿ç”¨çš„æ˜¯è¢«é­”æ”¹è¿‡çš„ï¼Œå®Œå…¨ä¸å¤ªå¯èƒ½ä»è€ç‰ˆæœ¬è·¨å‡ ä¸ªå¤§ç‰ˆæœ¬å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œ\næ‰€ä»¥æœ€åå†³å®šå†™Pythonè„šæœ¬è°ƒç”¨Gitlab APIå¯¼å‡ºç”¨æˆ·å’Œåˆ†ç»„ä»¥åŠé¡¹ç›®ï¼Œ\næ¥ç€é€šè¿‡Gitlab APIæ·»åŠ åˆ°æ–°çš„Gitlabä¸­ï¼Œç„¶åæŠŠæºç ä»“åº“æ•´ä¸ªæ–‡ä»¶å¤¹æ‹·è´åˆ°æ–°æœåŠ¡å™¨ï¼Œ\nä½¿ç”¨Pythonæ‰§è¡Œshellå‘½ä»¤ï¼ŒæŠŠæ‰€æœ‰çš„git è£¸ä»“åº“ æäº¤åˆ°æ–°çš„Gitlabä¸­ã€‚\nå¯¼å‡ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 import requests import json from loguru import logger from datetime import datetime # GitLab åŸŸå gitlab_domain = "gitlab.com" # GitLab é…ç½® GITLAB_URL = f&#39;https://{domain}&#39; # ä½ çš„ GitLab å®ä¾‹çš„ URL API_TOKEN = &#39;xxx&#39; # ä½ çš„ GitLab è®¿é—®ä»¤ç‰Œ # è€ç‰ˆæœ¬çš„Auth Tokenåœ¨ Header HEADERS = {&#39;PRIVATE-TOKEN&#39;: f&#39;{API_TOKEN}&#39;} # è·å–æ‰€æœ‰é¡¹ç›®çš„å‡½æ•° def get_all_projects(): url = f"{GITLAB_URL}/api/v4/projects" params = { "page": 1, # é»˜è®¤ç¬¬ä¸€é¡µ "per_page": 100 # æ¯é¡µæœ€å¤šè¿”å›100ä¸ªé¡¹ç›® } projects = [] while True: response = requests.get(url, headers=HEADERS, params=params) if response.status_code != 200: logger.error(f"Error: Unable to fetch data. Status code {response.status_code}") break data = response.json() if not data: logger.info("No more projects to fetch.") break projects.extend(data) params["page"] += 1 # è·å–ä¸‹ä¸€é¡µ logger.info(f"Fetched {len(data)} projects from page {params[&#39;page&#39;] - 1}.") return projects # æå–æ‰€éœ€çš„é¡¹ç›®æ•°æ® def extract_project_info(projects, rep_base): user_project_list = [ { &#39;name&#39;: p["name"], &#39;path_with_namespace&#39;: p["path_with_namespace"], &#39;default_branch&#39;: p["default_branch"], &#39;visibility&#39;: p["visibility"], &#39;ssh_url_to_repo&#39;: p["ssh_url_to_repo"], &#39;absolute_path&#39;: rep_base + p["ssh_url_to_repo"].replace(f&#39;git@{gitlab_domain}:&#39;, ""), &#39;new_ssh_url_to_repo&#39;: p["ssh_url_to_repo"].replace(f"git@{gitlab_domain}:", "git@127.0.0.1:"), } for p in projects ] return user_project_list # ä¿å­˜æ•°æ®åˆ°æ–‡ä»¶ def save_to_file(data, filename="old_all_projects.json"): with open(filename, "w", encoding="utf-8") as f: json.dump(data, f, indent=4, ensure_ascii=False) logger.info(f"Projects data has been saved to &#39;{filename}&#39;.") # ä¸»å‡½æ•° def main(): rep_base = "/var/opt/gitlab/git-data/back_repositories/repositories/" # ä½ è‡ªå·±çš„ä»“åº“è·¯å¾„ logger.info("Starting the project extraction process.") try: # è·å–æ‰€æœ‰é¡¹ç›® projects = get_all_projects() if not projects: logger.warning("No projects found or there was an issue fetching data.") return # æå–é¡¹ç›®ä¿¡æ¯ user_project_list = extract_project_info(projects, rep_base) # ä¿å­˜é¡¹ç›®åˆ—è¡¨åˆ°æ–‡ä»¶ save_to_file(user_project_list) logger.info("Process completed successfully.") except Exception as e: logger.error(f"An error occurred: {e}") if __name__ == "__main__": main() åˆ›å»ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 import requests import json import random import string from loguru import logger # æ–° GitLab å®ä¾‹çš„ URL å’Œä¸ªäººè®¿é—®ä»¤ç‰Œ NEW_GITLAB_URL = &#39;https://new-gitlab.com&#39; # æ–°çš„ GitLab å®ä¾‹ URL API_TOKEN = &#39;xxxx&#39; # æ–°çš„ GitLab ç®¡ç†å‘˜è®¿é—®ä»¤ç‰Œ # æ–°ç‰ˆæœ¬çš„é‰´æƒHeader ç”¨çš„ Authorization HEADERS = { &#39;Authorization&#39;: f&#39;Bearer {API_TOKEN}&#39; } # éšæœºç”Ÿæˆå¯†ç  def generate_random_password(length=12): characters = string.ascii_letters + string.digits + string.punctuation return &#39;&#39;.join(random.choice(characters) for i in range(length)) # ä» JSON æ–‡ä»¶ä¸­è¯»å–å¤‡ä»½æ•°æ® def load_backup_data(): with open("dump_gitlab_data.json", "r", encoding="utf-8") as f: return json.load(f) # åˆ›å»ºç”¨æˆ· def create_user(username, email, password): url = f"{NEW_GITLAB_URL}/api/v4/users" data = { "username": username, "name": username, "email": email, "password": password, "skip_confirmation": True, "force_random_password": True # å¼ºåˆ¶ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç  } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"User {username} created successfully.") return response.json() # è¿”å›åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ JSON except requests.RequestException as e: logger.error(f"Error creating user {username}: {e}") return None # åˆ›å»ºé¡¹ç›® def create_project(group_id, project_name): url = f"{NEW_GITLAB_URL}/api/v4/projects" data = { "name": project_name, "namespace_id": group_id, # å°†é¡¹ç›®æ”¾å…¥æŒ‡å®šçš„ç»„ "visibility": "private", "initialize_with_readme": False # é»˜è®¤åˆ›å»ºç©ºé¡¹ç›® } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"Project {project_name} created successfully in group {group_id}.") return response.json() # è¿”å›åˆ›å»ºçš„é¡¹ç›®æ•°æ® except requests.RequestException as e: logger.error(f"Error creating project {project_name} in group {group_id}: {e}") return None # åˆ›å»ºåˆ†ç»„ def create_group(group_name): url = f"{NEW_GITLAB_URL}/api/v4/groups" data = { "name": group_name, "path": group_name.lower().replace(" ", "_") # è‡ªåŠ¨ç”Ÿæˆè·¯å¾„ } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"Group {group_name} created successfully.") return response.json() # è¿”å›åŒ…å«åˆ†ç»„ä¿¡æ¯çš„ JSON except requests.RequestException as e: logger.error(f"Error creating group {group_name}: {e}") return None # æ·»åŠ ç”¨æˆ·åˆ°åˆ†ç»„å¹¶è®¾ç½®æƒé™ä¸º master def add_user_to_group(group_id, user_id, access_level=40): url = f"{NEW_GITLAB_URL}/api/v4/groups/{group_id}/members" data = { "user_id": user_id, "access_level": access_level # æƒé™è®¾ç½®ä¸º master (40) } try: response = requests.post(url, headers=HEADERS, data=data) response.raise_for_status() logger.info(f"User {user_id} added to group {group_id} with master access.") except requests.RequestException as e: logger.error(f"Error adding user {user_id} to group {group_id}: {e}") # å¯¼å…¥ç”¨æˆ·ã€åˆ†ç»„å’Œé¡¹ç›® def import_data(): logger.add("import_gitlab_entities.log", rotation="500 MB", compression="zip") # è¯»å–å¤‡ä»½æ•°æ® backup_data = load_backup_data() # å­˜å‚¨ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç  user_passwords = [] # åˆ›å»ºç”¨æˆ· for user in backup_data["users"]: username = user["username"] email = user["email"] password = generate_random_password() user_data = create_user(username, email, password) if user_data: user_id = user_data["id"] user_passwords.append({"username": username, "email": email, "password": password}) # åˆ›å»ºç”¨æˆ·çš„é¡¹ç›® for project in user["projects"]: project_name = project["name"] # æŸ¥æ‰¾é¡¹ç›®æ‰€å±çš„åˆ†ç»„ group_name = project["namespace"]["name"] # åˆ›å»ºé¡¹ç›®æ—¶éœ€è¦ä½¿ç”¨åˆ†ç»„IDï¼Œé¦–å…ˆè·å–åˆ†ç»„çš„ ID group_id = None for group in backup_data["groups"]: if group["name"] == group_name: group_id = create_group(group_name)["id"] break if group_id: create_project(group_id, project_name) # åˆ›å»ºé¡¹ç›®åï¼Œå°†ç”¨æˆ·æ·»åŠ åˆ°åˆ†ç»„ä¸­ add_user_to_group(group_id, user_id) # åˆ›å»ºåˆ†ç»„å’Œé¡¹ç›® for group in backup_data["groups"]: group_name = group["name"] group_data = create_group(group_name) if group_data: group_id = group_data["id"] # åˆ›å»ºåˆ†ç»„ä¸­çš„é¡¹ç›® for project in group["projects"]: project_name = project["name"] create_project(group_id, project_name) # æ·»åŠ å¯¹åº”çš„ç”¨æˆ·åˆ°åˆ†ç»„ï¼Œå¹¶è®¾ç½®ä¸º master æƒé™ for group_user in group["users"]: add_user_to_group(group_id, group_user["user_id"]) # å°†ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç ä¿å­˜åˆ° JSON æ–‡ä»¶ with open("user_passwords.json", "w", encoding="utf-8") as f: json.dump(user_passwords, f, ensure_ascii=False, indent=4) logger.info("User passwords have been exported to user_passwords.json") if __name__ == "__main__": import_data() æäº¤Git è£¸ä»“åº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 import os import subprocess import json from loguru import logger # è¯»å–é…ç½®çš„ JSON æ–‡ä»¶ def load_config(file_path): with open(file_path, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: return json.load(f) # å°†æ“ä½œç»“æœå†™å…¥åˆ° JSON æ–‡ä»¶ def write_result_to_json(results, output_file): with open(output_file, &#39;w+&#39;, encoding=&#39;utf-8&#39;) as f: json.dump(results, f, indent=4, ensure_ascii=False) # æ¨é€è£¸ä»“åº“åˆ°æ–°è¿œç«¯ def push_bare_repo_to_remote(project, results): absolute_path = project["absolute_path"] new_ssh_url_to_repo = project["new_ssh_url_to_repo"] # æ£€æŸ¥ä»“åº“è·¯å¾„æ˜¯å¦åˆæ³• if not os.path.isdir(absolute_path) or not os.path.exists(os.path.join(absolute_path, "HEAD")): logger.error(f"Invalid bare repository path: {absolute_path}") results.append({ "project": project, "status": "failed", "message": f"Invalid bare repository path: {absolute_path}" }) return try: # è¿›å…¥åŸå§‹ä»“åº“ç›®å½• logger.info(f"Accessing local bare repository: {absolute_path}") os.chdir(absolute_path) # ç¡®ä¿æ˜¯è£¸ä»“åº“ subprocess.run(["git", "rev-parse", "--is-bare-repository"], check=True) # è®¾ç½®æ–°çš„è¿œç«¯åœ°å€ logger.info(f"Setting new remote URL: {new_ssh_url_to_repo}") subprocess.run(["git", "remote", "add", "new-origin", new_ssh_url_to_repo], check=True) # æ¨é€æ‰€æœ‰åˆ†æ”¯åˆ°æ–°è¿œç«¯ logger.info("Pushing all branches to the new remote repository") subprocess.run(["git", "push", "new-origin", "--all","-f"], check=True) # æ¨é€æ‰€æœ‰æ ‡ç­¾åˆ°æ–°è¿œç«¯ logger.info("Pushing all tags to the new remote repository") subprocess.run(["git", "push", "new-origin", "--tags"], check=True) results.append({ "project": project, "status": "success", "message": f"Successfully pushed to {new_ssh_url_to_repo}" }) except subprocess.CalledProcessError as e: logger.error(f"Error during git operations: {e}") results.append({ "project": project, "status": "failed", "message": f"Error during git operations: {str(e)}" }) except Exception as e: logger.exception("Unexpected error occurred") results.append({ "project": project, "status": "failed", "message": f"Unexpected error: {str(e)}" }) finally: # ç§»é™¤æ–°è¿œç«¯é…ç½®ä»¥ä¿æŒåŸå§‹ä»“åº“æ¸…æ´ try: subprocess.run(["git", "remote", "remove", "new-origin"], check=True) except subprocess.CalledProcessError: logger.warning("Failed to remove new-origin remote, please check manually.") # ä¸»å‡½æ•° def main(): config_file = &#39;old_all_projects.json&#39; output_file = &#39;old_all_projects_result_2024.json&#39; projects = load_config(config_file) logger.add("all_projects_operation_log_2024.log", rotation="500 MB", level="INFO", compression="zip") results = [] for project in projects: logger.info(f"Processing project: {project[&#39;name&#39;]}") push_bare_repo_to_remote(project, results) write_result_to_json(results, output_file) logger.info(f"Operation results saved to {output_file}") if __name__ == "__main__": main() '><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/zh/><img src=/img/zhihu-lgb_hu_2ad0a9defe137384.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/zh>äººç”Ÿåˆ é™¤æŒ‡å—</a></h1><h2 class=site-description>liguobao</h2></div></header><ol class=menu-social><li><a href=https://github.com/liguobao target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/Liguobao2049 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.zhihu.com/people/codelover target=_blank title=çŸ¥ä¹ rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/zh/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/zh/liguobao-resume/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>About</span></a></li><li><a href=/zh/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/zh/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://liguobao.github.io/zh/ selected>ç®€ä½“ä¸­æ–‡</option><option value=https://liguobao.github.io/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#å¯¼å‡ºç”¨æˆ·åˆ†ç»„é¡¹ç›®>å¯¼å‡ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›®</a></li><li><a href=#åˆ›å»ºç”¨æˆ·åˆ†ç»„é¡¹ç›®>åˆ›å»ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›®</a></li><li><a href=#æäº¤git-è£¸ä»“åº“>æäº¤Git è£¸ä»“åº“</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/zh/categories/linux/ style=background-color:#2a9d8f;color:#fff>Linux</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/zh/p/gitlab-migration-low-version/>Gitlab ä½ç‰ˆæœ¬è¿ç§»ç®€æ˜“æ•™ç¨‹</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>11æœˆ 25, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>6 minute read</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://liguobao.github.io/p/gitlab-migration-low-version/ class=link>English</a></div></footer></div></header><section class=article-content><p>æœ€è¿‘åœ¨æŠ˜è…¾GitLabè¿ç§»ï¼Œç”±äºåŸGitLabç‰ˆæœ¬å®åœ¨æ˜¯å¤ªä½äº†ï¼Œ</p><p>åŒæ—¶ä½¿ç”¨çš„æ˜¯è¢«é­”æ”¹è¿‡çš„ï¼Œå®Œå…¨ä¸å¤ªå¯èƒ½ä»è€ç‰ˆæœ¬è·¨å‡ ä¸ªå¤§ç‰ˆæœ¬å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œ</p><p>æ‰€ä»¥æœ€åå†³å®šå†™Pythonè„šæœ¬è°ƒç”¨Gitlab APIå¯¼å‡ºç”¨æˆ·å’Œåˆ†ç»„ä»¥åŠé¡¹ç›®ï¼Œ</p><p>æ¥ç€é€šè¿‡Gitlab APIæ·»åŠ åˆ°æ–°çš„Gitlabä¸­ï¼Œç„¶åæŠŠæºç ä»“åº“æ•´ä¸ªæ–‡ä»¶å¤¹æ‹·è´åˆ°æ–°æœåŠ¡å™¨ï¼Œ</p><p>ä½¿ç”¨Pythonæ‰§è¡Œshellå‘½ä»¤ï¼ŒæŠŠæ‰€æœ‰çš„git è£¸ä»“åº“ æäº¤åˆ°æ–°çš„Gitlabä¸­ã€‚</p><h2 id=å¯¼å‡ºç”¨æˆ·åˆ†ç»„é¡¹ç›®>å¯¼å‡ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›®</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># GitLab åŸŸå</span>
</span></span><span class=line><span class=cl><span class=n>gitlab_domain</span> <span class=o>=</span> <span class=s2>&#34;gitlab.com&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># GitLab é…ç½®</span>
</span></span><span class=line><span class=cl><span class=n>GITLAB_URL</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;https://</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s1>&#39;</span>  <span class=c1># ä½ çš„ GitLab å®ä¾‹çš„ URL</span>
</span></span><span class=line><span class=cl><span class=n>API_TOKEN</span> <span class=o>=</span> <span class=s1>&#39;xxx&#39;</span>  <span class=c1># ä½ çš„ GitLab è®¿é—®ä»¤ç‰Œ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è€ç‰ˆæœ¬çš„Auth Tokenåœ¨ Header</span>
</span></span><span class=line><span class=cl><span class=n>HEADERS</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;PRIVATE-TOKEN&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>API_TOKEN</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è·å–æ‰€æœ‰é¡¹ç›®çš„å‡½æ•°</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_all_projects</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/projects&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;page&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>  <span class=c1># é»˜è®¤ç¬¬ä¸€é¡µ</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;per_page&#34;</span><span class=p>:</span> <span class=mi>100</span>  <span class=c1># æ¯é¡µæœ€å¤šè¿”å›100ä¸ªé¡¹ç›®</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>projects</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error: Unable to fetch data. Status code </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;No more projects to fetch.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>projects</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span><span class=p>[</span><span class=s2>&#34;page&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>  <span class=c1># è·å–ä¸‹ä¸€é¡µ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Fetched </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=si>}</span><span class=s2> projects from page </span><span class=si>{</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>projects</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æå–æ‰€éœ€çš„é¡¹ç›®æ•°æ®</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_project_info</span><span class=p>(</span><span class=n>projects</span><span class=p>,</span> <span class=n>rep_base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>user_project_list</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;path_with_namespace&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;path_with_namespace&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;default_branch&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;default_branch&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;visibility&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;visibility&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ssh_url_to_repo&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;ssh_url_to_repo&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;absolute_path&#39;</span><span class=p>:</span> <span class=n>rep_base</span> <span class=o>+</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;ssh_url_to_repo&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;git@</span><span class=si>{</span><span class=n>gitlab_domain</span><span class=si>}</span><span class=s1>:&#39;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;new_ssh_url_to_repo&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;ssh_url_to_repo&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;git@</span><span class=si>{</span><span class=n>gitlab_domain</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>,</span> <span class=s2>&#34;git@127.0.0.1:&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>projects</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>user_project_list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¿å­˜æ•°æ®åˆ°æ–‡ä»¶</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>save_to_file</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=s2>&#34;old_all_projects.json&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Projects data has been saved to &#39;</span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>&#39;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¸»å‡½æ•°</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>rep_base</span> <span class=o>=</span> <span class=s2>&#34;/var/opt/gitlab/git-data/back_repositories/repositories/&#34;</span>  <span class=c1># ä½ è‡ªå·±çš„ä»“åº“è·¯å¾„</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Starting the project extraction process.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># è·å–æ‰€æœ‰é¡¹ç›®</span>
</span></span><span class=line><span class=cl>        <span class=n>projects</span> <span class=o>=</span> <span class=n>get_all_projects</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>projects</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;No projects found or there was an issue fetching data.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># æå–é¡¹ç›®ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>        <span class=n>user_project_list</span> <span class=o>=</span> <span class=n>extract_project_info</span><span class=p>(</span><span class=n>projects</span><span class=p>,</span> <span class=n>rep_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># ä¿å­˜é¡¹ç›®åˆ—è¡¨åˆ°æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>        <span class=n>save_to_file</span><span class=p>(</span><span class=n>user_project_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Process completed successfully.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;An error occurred: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=åˆ›å»ºç”¨æˆ·åˆ†ç»„é¡¹ç›®>åˆ›å»ºç”¨æˆ·ã€åˆ†ç»„ã€é¡¹ç›®</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ–° GitLab å®ä¾‹çš„ URL å’Œä¸ªäººè®¿é—®ä»¤ç‰Œ</span>
</span></span><span class=line><span class=cl><span class=n>NEW_GITLAB_URL</span> <span class=o>=</span> <span class=s1>&#39;https://new-gitlab.com&#39;</span>  <span class=c1># æ–°çš„ GitLab å®ä¾‹ URL</span>
</span></span><span class=line><span class=cl><span class=n>API_TOKEN</span> <span class=o>=</span> <span class=s1>&#39;xxxx&#39;</span>  <span class=c1># æ–°çš„ GitLab ç®¡ç†å‘˜è®¿é—®ä»¤ç‰Œ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ–°ç‰ˆæœ¬çš„é‰´æƒHeader ç”¨çš„ Authorization</span>
</span></span><span class=line><span class=cl><span class=n>HEADERS</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Authorization&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;Bearer </span><span class=si>{</span><span class=n>API_TOKEN</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1># éšæœºç”Ÿæˆå¯†ç </span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_random_password</span><span class=p>(</span><span class=n>length</span><span class=o>=</span><span class=mi>12</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>characters</span> <span class=o>=</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>punctuation</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>characters</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>length</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä» JSON æ–‡ä»¶ä¸­è¯»å–å¤‡ä»½æ•°æ®</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_backup_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;dump_gitlab_data.json&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºç”¨æˆ·</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_user</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>NEW_GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/users&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;skip_confirmation&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;force_random_password&#34;</span><span class=p>:</span> <span class=kc>True</span>  <span class=c1># å¼ºåˆ¶ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç </span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;User </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2> created successfully.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>  <span class=c1># è¿”å›åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ JSON</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error creating user </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºé¡¹ç›®</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_project</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>project_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>NEW_GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/projects&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>project_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;namespace_id&#34;</span><span class=p>:</span> <span class=n>group_id</span><span class=p>,</span>  <span class=c1># å°†é¡¹ç›®æ”¾å…¥æŒ‡å®šçš„ç»„</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;visibility&#34;</span><span class=p>:</span> <span class=s2>&#34;private&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;initialize_with_readme&#34;</span><span class=p>:</span> <span class=kc>False</span>  <span class=c1># é»˜è®¤åˆ›å»ºç©ºé¡¹ç›®</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Project </span><span class=si>{</span><span class=n>project_name</span><span class=si>}</span><span class=s2> created successfully in group </span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>  <span class=c1># è¿”å›åˆ›å»ºçš„é¡¹ç›®æ•°æ®</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error creating project </span><span class=si>{</span><span class=n>project_name</span><span class=si>}</span><span class=s2> in group </span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºåˆ†ç»„</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_group</span><span class=p>(</span><span class=n>group_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>NEW_GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/groups&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>group_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;path&#34;</span><span class=p>:</span> <span class=n>group_name</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=s2>&#34;_&#34;</span><span class=p>)</span>  <span class=c1># è‡ªåŠ¨ç”Ÿæˆè·¯å¾„</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Group </span><span class=si>{</span><span class=n>group_name</span><span class=si>}</span><span class=s2> created successfully.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>  <span class=c1># è¿”å›åŒ…å«åˆ†ç»„ä¿¡æ¯çš„ JSON</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error creating group </span><span class=si>{</span><span class=n>group_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ·»åŠ ç”¨æˆ·åˆ°åˆ†ç»„å¹¶è®¾ç½®æƒé™ä¸º master</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_user_to_group</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>access_level</span><span class=o>=</span><span class=mi>40</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>NEW_GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/groups/</span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2>/members&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;access_level&#34;</span><span class=p>:</span> <span class=n>access_level</span>  <span class=c1># æƒé™è®¾ç½®ä¸º master (40)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;User </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2> added to group </span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2> with master access.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error adding user </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2> to group </span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯¼å…¥ç”¨æˆ·ã€åˆ†ç»„å’Œé¡¹ç›®</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>import_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;import_gitlab_entities.log&#34;</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=s2>&#34;500 MB&#34;</span><span class=p>,</span> <span class=n>compression</span><span class=o>=</span><span class=s2>&#34;zip&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¯»å–å¤‡ä»½æ•°æ®</span>
</span></span><span class=line><span class=cl>    <span class=n>backup_data</span> <span class=o>=</span> <span class=n>load_backup_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å­˜å‚¨ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç </span>
</span></span><span class=line><span class=cl>    <span class=n>user_passwords</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># åˆ›å»ºç”¨æˆ·</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>backup_data</span><span class=p>[</span><span class=s2>&#34;users&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>user</span><span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>email</span> <span class=o>=</span> <span class=n>user</span><span class=p>[</span><span class=s2>&#34;email&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>generate_random_password</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>user_data</span> <span class=o>=</span> <span class=n>create_user</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span> <span class=o>=</span> <span class=n>user_data</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>user_passwords</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span> <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span> <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># åˆ›å»ºç”¨æˆ·çš„é¡¹ç›®</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>project</span> <span class=ow>in</span> <span class=n>user</span><span class=p>[</span><span class=s2>&#34;projects&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>project_name</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=c1># æŸ¥æ‰¾é¡¹ç›®æ‰€å±çš„åˆ†ç»„</span>
</span></span><span class=line><span class=cl>                <span class=n>group_name</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;namespace&#34;</span><span class=p>][</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=c1># åˆ›å»ºé¡¹ç›®æ—¶éœ€è¦ä½¿ç”¨åˆ†ç»„IDï¼Œé¦–å…ˆè·å–åˆ†ç»„çš„ ID</span>
</span></span><span class=line><span class=cl>                <span class=n>group_id</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>group</span> <span class=ow>in</span> <span class=n>backup_data</span><span class=p>[</span><span class=s2>&#34;groups&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>group</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>group_name</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>group_id</span> <span class=o>=</span> <span class=n>create_group</span><span class=p>(</span><span class=n>group_name</span><span class=p>)[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>group_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>create_project</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>project_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=c1># åˆ›å»ºé¡¹ç›®åï¼Œå°†ç”¨æˆ·æ·»åŠ åˆ°åˆ†ç»„ä¸­</span>
</span></span><span class=line><span class=cl>                    <span class=n>add_user_to_group</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># åˆ›å»ºåˆ†ç»„å’Œé¡¹ç›®</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>group</span> <span class=ow>in</span> <span class=n>backup_data</span><span class=p>[</span><span class=s2>&#34;groups&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>group_name</span> <span class=o>=</span> <span class=n>group</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>group_data</span> <span class=o>=</span> <span class=n>create_group</span><span class=p>(</span><span class=n>group_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>group_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>group_id</span> <span class=o>=</span> <span class=n>group_data</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># åˆ›å»ºåˆ†ç»„ä¸­çš„é¡¹ç›®</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>project</span> <span class=ow>in</span> <span class=n>group</span><span class=p>[</span><span class=s2>&#34;projects&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>project_name</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>create_project</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>project_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># æ·»åŠ å¯¹åº”çš„ç”¨æˆ·åˆ°åˆ†ç»„ï¼Œå¹¶è®¾ç½®ä¸º master æƒé™</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>group_user</span> <span class=ow>in</span> <span class=n>group</span><span class=p>[</span><span class=s2>&#34;users&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>add_user_to_group</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>group_user</span><span class=p>[</span><span class=s2>&#34;user_id&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å°†ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç ä¿å­˜åˆ° JSON æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;user_passwords.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>user_passwords</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;User passwords have been exported to user_passwords.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>import_data</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=æäº¤git-è£¸ä»“åº“>æäº¤Git è£¸ä»“åº“</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¯»å–é…ç½®çš„ JSON æ–‡ä»¶</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_config</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å°†æ“ä½œç»“æœå†™å…¥åˆ° JSON æ–‡ä»¶</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_result_to_json</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>output_file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;w+&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ¨é€è£¸ä»“åº“åˆ°æ–°è¿œç«¯</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>push_bare_repo_to_remote</span><span class=p>(</span><span class=n>project</span><span class=p>,</span> <span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>absolute_path</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;absolute_path&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>new_ssh_url_to_repo</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;new_ssh_url_to_repo&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ£€æŸ¥ä»“åº“è·¯å¾„æ˜¯å¦åˆæ³•</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>absolute_path</span><span class=p>)</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>absolute_path</span><span class=p>,</span> <span class=s2>&#34;HEAD&#34;</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Invalid bare repository path: </span><span class=si>{</span><span class=n>absolute_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;project&#34;</span><span class=p>:</span> <span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Invalid bare repository path: </span><span class=si>{</span><span class=n>absolute_path</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># è¿›å…¥åŸå§‹ä»“åº“ç›®å½•</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Accessing local bare repository: </span><span class=si>{</span><span class=n>absolute_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>chdir</span><span class=p>(</span><span class=n>absolute_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># ç¡®ä¿æ˜¯è£¸ä»“åº“</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;rev-parse&#34;</span><span class=p>,</span> <span class=s2>&#34;--is-bare-repository&#34;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># è®¾ç½®æ–°çš„è¿œç«¯åœ°å€</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Setting new remote URL: </span><span class=si>{</span><span class=n>new_ssh_url_to_repo</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;remote&#34;</span><span class=p>,</span> <span class=s2>&#34;add&#34;</span><span class=p>,</span> <span class=s2>&#34;new-origin&#34;</span><span class=p>,</span> <span class=n>new_ssh_url_to_repo</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># æ¨é€æ‰€æœ‰åˆ†æ”¯åˆ°æ–°è¿œç«¯</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Pushing all branches to the new remote repository&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;push&#34;</span><span class=p>,</span> <span class=s2>&#34;new-origin&#34;</span><span class=p>,</span> <span class=s2>&#34;--all&#34;</span><span class=p>,</span><span class=s2>&#34;-f&#34;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># æ¨é€æ‰€æœ‰æ ‡ç­¾åˆ°æ–°è¿œç«¯</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Pushing all tags to the new remote repository&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;push&#34;</span><span class=p>,</span> <span class=s2>&#34;new-origin&#34;</span><span class=p>,</span> <span class=s2>&#34;--tags&#34;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;project&#34;</span><span class=p>:</span> <span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Successfully pushed to </span><span class=si>{</span><span class=n>new_ssh_url_to_repo</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error during git operations: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;project&#34;</span><span class=p>:</span> <span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Error during git operations: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>exception</span><span class=p>(</span><span class=s2>&#34;Unexpected error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;project&#34;</span><span class=p>:</span> <span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Unexpected error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># ç§»é™¤æ–°è¿œç«¯é…ç½®ä»¥ä¿æŒåŸå§‹ä»“åº“æ¸…æ´</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;remote&#34;</span><span class=p>,</span> <span class=s2>&#34;remove&#34;</span><span class=p>,</span> <span class=s2>&#34;new-origin&#34;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;Failed to remove new-origin remote, please check manually.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¸»å‡½æ•°</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>config_file</span> <span class=o>=</span> <span class=s1>&#39;old_all_projects.json&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>output_file</span> <span class=o>=</span> <span class=s1>&#39;old_all_projects_result_2024.json&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>projects</span> <span class=o>=</span> <span class=n>load_config</span><span class=p>(</span><span class=n>config_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;all_projects_operation_log_2024.log&#34;</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=s2>&#34;500 MB&#34;</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=s2>&#34;INFO&#34;</span><span class=p>,</span> <span class=n>compression</span><span class=o>=</span><span class=s2>&#34;zip&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>project</span> <span class=ow>in</span> <span class=n>projects</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Processing project: </span><span class=si>{</span><span class=n>project</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>push_bare_repo_to_remote</span><span class=p>(</span><span class=n>project</span><span class=p>,</span> <span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>write_result_to_json</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>output_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Operation results saved to </span><span class=si>{</span><span class=n>output_file</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/zh/tags/linux/>Linux</a>
<a href=/zh/tags/git/>Git</a>
<a href=/zh/tags/gitlab/>Gitlab</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/zh/p/linux-du/><div class=article-details><h2 class=article-title>Linux du å‘½ä»¤</h2></div></a></article><article class=has-image><a href=/zh/p/k3s-tailscale-cluster-2026/><div class=article-image><img src=/zh/p/k3s-tailscale-cluster-2026/logo.416a519b962aa328ad5aad8af8a2a581_hu_b3dda3c4c41b8483.png width=250 height=150 loading=lazy alt="Featured image of post 2206å¹´æœ€ä½³è¾¹ç¼˜è®¡ç®—é›†ç¾¤æ–¹æ¡ˆï¼šTailscale + k3s" data-key=k3s-tailscale-cluster-2026 data-hash="md5-QWpRm5YqoyitWq2K+KKlgQ=="></div><div class=article-details><h2 class=article-title>2206å¹´æœ€ä½³è¾¹ç¼˜è®¡ç®—é›†ç¾¤æ–¹æ¡ˆï¼šTailscale + k3s</h2></div></a></article><article class=has-image><a href=/zh/p/vibe-coding-deploy-tailscale/><div class=article-image><img src=/zh/p/vibe-coding-deploy-tailscale/logo.10bf2686f0c9b97299c4d0132f81bb64_hu_a7ff9109abcc5753.png width=250 height=150 loading=lazy alt="Featured image of post è°ä¸æƒ³è¦è‡ªå·±çš„Tailscaleå†…ç½‘å‘¢~" data-key=vibe-coding-deploy-tailscale data-hash="md5-EL8mhvDJuXKZxNATL4G7ZA=="></div><div class=article-details><h2 class=article-title>è°ä¸æƒ³è¦è‡ªå·±çš„Tailscaleå†…ç½‘å‘¢~</h2></div></a></article><article class=has-image><a href=/zh/p/unitree-g1-develop-on-raspberry-pi/><div class=article-image><img src=/zh/p/unitree-g1-develop-on-raspberry-pi/logo.764fd995f255db159e0fd3c98a914fb3_hu_6a7c739f48c7a5dd.png width=250 height=150 loading=lazy alt="Featured image of post å®‡æ ‘æœºå™¨äººG1ä¾¿æºå¼€å‘æŒ‡åŒ—ï¼šåŸºäºæ ‘è“æ´¾çš„ç¯å¢ƒæ­å»º" data-key=unitree-g1-develop-on-raspberry-pi data-hash="md5-dk/ZlfJV2xWeD9PJipFPsw=="></div><div class=article-details><h2 class=article-title>å®‡æ ‘æœºå™¨äººG1ä¾¿æºå¼€å‘æŒ‡åŒ—ï¼šåŸºäºæ ‘è“æ´¾çš„ç¯å¢ƒæ­å»º</h2></div></a></article><article class=has-image><a href=/zh/p/ubuntu-wifi-loss/><div class=article-image><img src=/zh/p/ubuntu-wifi-loss/xiaohei.affc1140e57282b122228f5d5d455d2f_hu_b0100a163c136d87.png width=250 height=150 loading=lazy alt="Featured image of post Ubuntu æœ‰çº¿ç½‘å¡æ‰çº¿é‡å¯å¤‡å¿˜" data-key=ubuntu-wifi-loss data-hash="md5-r/wRQOVygrEiIo9dXUVdLw=="></div><div class=article-details><h2 class=article-title>Ubuntu æœ‰çº¿ç½‘å¡æ‰çº¿é‡å¯å¤‡å¿˜</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=liguobao/liguobao.github.io issue-term=title crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 äººç”Ÿåˆ é™¤æŒ‡å—</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>