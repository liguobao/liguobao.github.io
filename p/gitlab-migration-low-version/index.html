<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="GitLab, Migration, Low Version"><title>GitLab Low Version Migration Simple Tutorial</title><link rel=canonical href=https://liguobao.github.io/p/gitlab-migration-low-version/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="GitLab Low Version Migration Simple Tutorial"><meta property='og:description' content="GitLab, Migration, Low Version"><meta property='og:url' content='https://liguobao.github.io/p/gitlab-migration-low-version/'><meta property='og:site_name' content='Life Deletion Guide'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='linux'><meta property='article:tag' content='Git'><meta property='article:tag' content='Gitlab'><meta property='article:published_time' content='2024-11-25T08:00:00+00:00'><meta property='article:modified_time' content='2024-11-25T08:00:00+00:00'><meta name=twitter:title content="GitLab Low Version Migration Simple Tutorial"><meta name=twitter:description content="GitLab, Migration, Low Version"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/zhihu-lgb_hu_2ad0a9defe137384.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>Life Deletion Guide</a></h1><h2 class=site-description>liguobao</h2></div></header><ol class=menu-social><li><a href=https://github.com/liguobao target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/Liguobao2049 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.zhihu.com/people/codelover target=_blank title=Áü•‰πé rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/liguobao-resume/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>About</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://liguobao.github.io/zh/>ÁÆÄ‰Ωì‰∏≠Êñá</option><option value=https://liguobao.github.io/ selected>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#export-users-groups-projects>Export Users, Groups, Projects</a></li><li><a href=#create-users-groups-projects>Create Users, Groups, Projects</a></li><li><a href=#push-git-bare-repositories>Push Git Bare Repositories</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/linux/ style=background-color:#2a9d8f;color:#fff>Linux</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/gitlab-migration-low-version/>GitLab Low Version Migration Simple Tutorial</a></h2><h3 class=article-subtitle>GitLab, Migration, Low Version</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 25, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>8 minute read</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://liguobao.github.io/zh/p/gitlab-migration-low-version/ class=link>ÁÆÄ‰Ωì‰∏≠Êñá</a></div></footer></div></header><section class=article-content><p>Recently working on GitLab migration, since the original GitLab version is too low, and it&rsquo;s modified, completely impossible to upgrade from old version across several major versions to latest. So finally decided to write Python script to call GitLab API to export users, groups, and projects, then add to new GitLab via API, then copy the source repository entire folder to new server, use Python to execute shell commands, push all git bare repositories to new GitLab.</p><h2 id=export-users-groups-projects>Export Users, Groups, Projects</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># GitLab domain</span>
</span></span><span class=line><span class=cl><span class=n>gitlab_domain</span> <span class=o>=</span> <span class=s2>&#34;gitlab.com&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># GitLab config</span>
</span></span><span class=line><span class=cl><span class=n>GITLAB_URL</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;https://</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s1>&#39;</span>  <span class=c1># Your GitLab instance URL</span>
</span></span><span class=line><span class=cl><span class=n>API_TOKEN</span> <span class=o>=</span> <span class=s1>&#39;xxx&#39;</span>  <span class=c1># Your GitLab access token</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Old version Auth Token in Header</span>
</span></span><span class=line><span class=cl><span class=n>HEADERS</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;PRIVATE-TOKEN&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>API_TOKEN</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Function to get all projects</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_all_projects</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/projects&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;page&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>  <span class=c1># Default first page</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;per_page&#34;</span><span class=p>:</span> <span class=mi>100</span>  <span class=c1># Max 100 projects per page</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>projects</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error: Unable to fetch data. Status code </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;No more projects to fetch.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>projects</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span><span class=p>[</span><span class=s2>&#34;page&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>  <span class=c1># Get next page</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Fetched </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=si>}</span><span class=s2> projects from page </span><span class=si>{</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>projects</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Extract required project data</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_project_info</span><span class=p>(</span><span class=n>projects</span><span class=p>,</span> <span class=n>rep_base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>user_project_list</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;path_with_namespace&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;path_with_namespace&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;default_branch&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;default_branch&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;visibility&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;visibility&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ssh_url_to_repo&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;ssh_url_to_repo&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;absolute_path&#39;</span><span class=p>:</span> <span class=n>rep_base</span> <span class=o>+</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;ssh_url_to_repo&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;git@</span><span class=si>{</span><span class=n>gitlab_domain</span><span class=si>}</span><span class=s1>:&#39;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;new_ssh_url_to_repo&#39;</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;ssh_url_to_repo&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;git@</span><span class=si>{</span><span class=n>gitlab_domain</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>,</span> <span class=s2>&#34;git@127.0.0.1:&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>projects</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>user_project_list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Save data to file</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>save_to_file</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=s2>&#34;old_all_projects.json&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Projects data has been saved to &#39;</span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>&#39;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Main function</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>rep_base</span> <span class=o>=</span> <span class=s2>&#34;/var/opt/gitlab/git-data/back_repositories/repositories/&#34;</span>  <span class=c1># Your own repository path</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Starting the project extraction process.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Get all projects</span>
</span></span><span class=line><span class=cl>        <span class=n>projects</span> <span class=o>=</span> <span class=n>get_all_projects</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>projects</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;No projects found or there was an issue fetching data.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Extract project info</span>
</span></span><span class=line><span class=cl>        <span class=n>user_project_list</span> <span class=o>=</span> <span class=n>extract_project_info</span><span class=p>(</span><span class=n>projects</span><span class=p>,</span> <span class=n>rep_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Save project list to file</span>
</span></span><span class=line><span class=cl>        <span class=n>save_to_file</span><span class=p>(</span><span class=n>user_project_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Process completed successfully.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;An error occurred: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=create-users-groups-projects>Create Users, Groups, Projects</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># New GitLab instance URL and personal access token</span>
</span></span><span class=line><span class=cl><span class=n>NEW_GITLAB_URL</span> <span class=o>=</span> <span class=s1>&#39;https://new-gitlab.com&#39;</span>  <span class=c1># New GitLab instance URL</span>
</span></span><span class=line><span class=cl><span class=n>API_TOKEN</span> <span class=o>=</span> <span class=s1>&#39;xxxx&#39;</span>  <span class=c1># New GitLab admin access token</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># New version auth header uses Authorization</span>
</span></span><span class=line><span class=cl><span class=n>HEADERS</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Authorization&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;Bearer </span><span class=si>{</span><span class=n>API_TOKEN</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Generate random password</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_random_password</span><span class=p>(</span><span class=n>length</span><span class=o>=</span><span class=mi>12</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>characters</span> <span class=o>=</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>punctuation</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>characters</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>length</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load backup data from JSON file</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_backup_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;dump_gitlab_data.json&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create user</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_user</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>NEW_GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/users&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;skip_confirmation&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;force_random_password&#34;</span><span class=p>:</span> <span class=kc>True</span>  <span class=c1># Force user to change password on first login</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;User </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2> created successfully.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>  <span class=c1># Return JSON with user info</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error creating user </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create project</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_project</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>project_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>NEW_GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/projects&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>project_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;namespace_id&#34;</span><span class=p>:</span> <span class=n>group_id</span><span class=p>,</span>  <span class=c1># Put project in specified group</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;visibility&#34;</span><span class=p>:</span> <span class=s2>&#34;private&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;initialize_with_readme&#34;</span><span class=p>:</span> <span class=kc>False</span>  <span class=c1># Create empty project by default</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Project </span><span class=si>{</span><span class=n>project_name</span><span class=si>}</span><span class=s2> created successfully in group </span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>  <span class=c1># Return created project data</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error creating project </span><span class=si>{</span><span class=n>project_name</span><span class=si>}</span><span class=s2> in group </span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create group</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_group</span><span class=p>(</span><span class=n>group_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>NEW_GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/groups&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>group_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;path&#34;</span><span class=p>:</span> <span class=n>group_name</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=s2>&#34;_&#34;</span><span class=p>)</span>  <span class=c1># Auto generate path</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Group </span><span class=si>{</span><span class=n>group_name</span><span class=si>}</span><span class=s2> created successfully.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>  <span class=c1># Return JSON with group info</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error creating group </span><span class=si>{</span><span class=n>group_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Add user to group and set permission to master</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_user_to_group</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>access_level</span><span class=o>=</span><span class=mi>40</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>NEW_GITLAB_URL</span><span class=si>}</span><span class=s2>/api/v4/groups/</span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2>/members&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;access_level&#34;</span><span class=p>:</span> <span class=n>access_level</span>  <span class=c1># Set permission to master (40)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>HEADERS</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;User </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2> added to group </span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2> with master access.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error adding user </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2> to group </span><span class=si>{</span><span class=n>group_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Import users, groups, and projects</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>import_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;import_gitlab_entities.log&#34;</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=s2>&#34;500 MB&#34;</span><span class=p>,</span> <span class=n>compression</span><span class=o>=</span><span class=s2>&#34;zip&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Load backup data</span>
</span></span><span class=line><span class=cl>    <span class=n>backup_data</span> <span class=o>=</span> <span class=n>load_backup_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Store username, email, password</span>
</span></span><span class=line><span class=cl>    <span class=n>user_passwords</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create users</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>backup_data</span><span class=p>[</span><span class=s2>&#34;users&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>user</span><span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>email</span> <span class=o>=</span> <span class=n>user</span><span class=p>[</span><span class=s2>&#34;email&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>generate_random_password</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>user_data</span> <span class=o>=</span> <span class=n>create_user</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span> <span class=o>=</span> <span class=n>user_data</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>user_passwords</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span> <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span> <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Create user&#39;s projects</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>project</span> <span class=ow>in</span> <span class=n>user</span><span class=p>[</span><span class=s2>&#34;projects&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>project_name</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=c1># Find project&#39;s group</span>
</span></span><span class=line><span class=cl>                <span class=n>group_name</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;namespace&#34;</span><span class=p>][</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=c1># When creating project, need group ID, first get group&#39;s ID</span>
</span></span><span class=line><span class=cl>                <span class=n>group_id</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>group</span> <span class=ow>in</span> <span class=n>backup_data</span><span class=p>[</span><span class=s2>&#34;groups&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>group</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>group_name</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>group_id</span> <span class=o>=</span> <span class=n>create_group</span><span class=p>(</span><span class=n>group_name</span><span class=p>)[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>group_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>create_project</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>project_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=c1># After creating project, add user to group</span>
</span></span><span class=line><span class=cl>                    <span class=n>add_user_to_group</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create groups and projects</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>group</span> <span class=ow>in</span> <span class=n>backup_data</span><span class=p>[</span><span class=s2>&#34;groups&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>group_name</span> <span class=o>=</span> <span class=n>group</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>group_data</span> <span class=o>=</span> <span class=n>create_group</span><span class=p>(</span><span class=n>group_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>group_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>group_id</span> <span class=o>=</span> <span class=n>group_data</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># Create projects in group</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>project</span> <span class=ow>in</span> <span class=n>group</span><span class=p>[</span><span class=s2>&#34;projects&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>project_name</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>create_project</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>project_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Add corresponding users to group, set to master permission</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>group_user</span> <span class=ow>in</span> <span class=n>group</span><span class=p>[</span><span class=s2>&#34;users&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>add_user_to_group</span><span class=p>(</span><span class=n>group_id</span><span class=p>,</span> <span class=n>group_user</span><span class=p>[</span><span class=s2>&#34;user_id&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Save username, email, password to JSON file</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;user_passwords.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>user_passwords</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;User passwords have been exported to user_passwords.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>import_data</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=push-git-bare-repositories>Push Git Bare Repositories</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load config JSON file</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_config</span><span class=p>(</span><span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Write operation results to JSON file</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_result_to_json</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>output_file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;w+&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Push bare repo to new remote</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>push_bare_repo_to_remote</span><span class=p>(</span><span class=n>project</span><span class=p>,</span> <span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>absolute_path</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;absolute_path&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>new_ssh_url_to_repo</span> <span class=o>=</span> <span class=n>project</span><span class=p>[</span><span class=s2>&#34;new_ssh_url_to_repo&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check if repo path is valid</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>absolute_path</span><span class=p>)</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>absolute_path</span><span class=p>,</span> <span class=s2>&#34;HEAD&#34;</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Invalid bare repository path: </span><span class=si>{</span><span class=n>absolute_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;project&#34;</span><span class=p>:</span> <span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Invalid bare repository path: </span><span class=si>{</span><span class=n>absolute_path</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Enter original repo directory</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Accessing local bare repository: </span><span class=si>{</span><span class=n>absolute_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>chdir</span><span class=p>(</span><span class=n>absolute_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Ensure it&#39;s bare repo</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;rev-parse&#34;</span><span class=p>,</span> <span class=s2>&#34;--is-bare-repository&#34;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Set new remote URL</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Setting new remote URL: </span><span class=si>{</span><span class=n>new_ssh_url_to_repo</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;remote&#34;</span><span class=p>,</span> <span class=s2>&#34;add&#34;</span><span class=p>,</span> <span class=s2>&#34;new-origin&#34;</span><span class=p>,</span> <span class=n>new_ssh_url_to_repo</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Push all branches to new remote</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Pushing all branches to the new remote repository&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;push&#34;</span><span class=p>,</span> <span class=s2>&#34;new-origin&#34;</span><span class=p>,</span> <span class=s2>&#34;--all&#34;</span><span class=p>,</span><span class=s2>&#34;-f&#34;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Push all tags to new remote</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Pushing all tags to the new remote repository&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;push&#34;</span><span class=p>,</span> <span class=s2>&#34;new-origin&#34;</span><span class=p>,</span> <span class=s2>&#34;--tags&#34;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;project&#34;</span><span class=p>:</span> <span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Successfully pushed to </span><span class=si>{</span><span class=n>new_ssh_url_to_repo</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error during git operations: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;project&#34;</span><span class=p>:</span> <span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Error during git operations: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>exception</span><span class=p>(</span><span class=s2>&#34;Unexpected error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;project&#34;</span><span class=p>:</span> <span class=n>project</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Unexpected error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Remove new remote config to keep original repo clean</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;remote&#34;</span><span class=p>,</span> <span class=s2>&#34;remove&#34;</span><span class=p>,</span> <span class=s2>&#34;new-origin&#34;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;Failed to remove new-origin remote, please check manually.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Main function</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>config_file</span> <span class=o>=</span> <span class=s1>&#39;old_all_projects.json&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>output_file</span> <span class=o>=</span> <span class=s1>&#39;old_all_projects_result_2024.json&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>projects</span> <span class=o>=</span> <span class=n>load_config</span><span class=p>(</span><span class=n>config_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;all_projects_operation_log_2024.log&#34;</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=s2>&#34;500 MB&#34;</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=s2>&#34;INFO&#34;</span><span class=p>,</span> <span class=n>compression</span><span class=o>=</span><span class=s2>&#34;zip&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>project</span> <span class=ow>in</span> <span class=n>projects</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Processing project: </span><span class=si>{</span><span class=n>project</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>push_bare_repo_to_remote</span><span class=p>(</span><span class=n>project</span><span class=p>,</span> <span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>write_result_to_json</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>output_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Operation results saved to </span><span class=si>{</span><span class=n>output_file</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/linux/>Linux</a>
<a href=/tags/git/>Git</a>
<a href=/tags/gitlab/>Gitlab</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/linux-du/><div class=article-details><h2 class=article-title>Linux du Command</h2></div></a></article><article class=has-image><a href=/p/k3s-tailscale-cluster-2026/><div class=article-image><img src=/zh/p/k3s-tailscale-cluster-2026/logo.416a519b962aa328ad5aad8af8a2a581_hu_b3dda3c4c41b8483.png width=250 height=150 loading=lazy alt="Featured image of post Best Edge Computing Cluster Solution: Tailscale + K3s (2026 Edition)" data-key=k3s-tailscale-cluster-2026 data-hash="md5-QWpRm5YqoyitWq2K+KKlgQ=="></div><div class=article-details><h2 class=article-title>Best Edge Computing Cluster Solution: Tailscale + K3s (2026 Edition)</h2></div></a></article><article class=has-image><a href=/p/vibe-coding-deploy-tailscale/><div class=article-image><img src=/zh/p/vibe-coding-deploy-tailscale/logo.10bf2686f0c9b97299c4d0132f81bb64_hu_a7ff9109abcc5753.png width=250 height=150 loading=lazy alt="Featured image of post Who Doesn't Want Their Own Tailscale Private Network?" data-key=vibe-coding-deploy-tailscale data-hash="md5-EL8mhvDJuXKZxNATL4G7ZA=="></div><div class=article-details><h2 class=article-title>Who Doesn't Want Their Own Tailscale Private Network?</h2></div></a></article><article class=has-image><a href=/p/unitree-g1-develop-on-raspberry-pi/><div class=article-image><img src=/zh/p/unitree-g1-develop-on-raspberry-pi/logo.764fd995f255db159e0fd3c98a914fb3_hu_6a7c739f48c7a5dd.png width=250 height=150 loading=lazy alt="Featured image of post Unitree G1 Portable Development Guide: Raspberry Pi-based Development Environment" data-key=unitree-g1-develop-on-raspberry-pi data-hash="md5-dk/ZlfJV2xWeD9PJipFPsw=="></div><div class=article-details><h2 class=article-title>Unitree G1 Portable Development Guide: Raspberry Pi-based Development Environment</h2></div></a></article><article class=has-image><a href=/p/ubuntu-wifi-loss/><div class=article-image><img src=/zh/p/ubuntu-wifi-loss/xiaohei.affc1140e57282b122228f5d5d455d2f_hu_b0100a163c136d87.png width=250 height=150 loading=lazy alt="Featured image of post Ubuntu Ethernet Drops ‚Äî Quick Reset Notes" data-key=ubuntu-wifi-loss data-hash="md5-r/wRQOVygrEiIo9dXUVdLw=="></div><div class=article-details><h2 class=article-title>Ubuntu Ethernet Drops ‚Äî Quick Reset Notes</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=liguobao/liguobao.github.io issue-term=title crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 Life Deletion Guide</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>