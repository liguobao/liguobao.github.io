<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='一次依赖注入不慎引发的一连串事故。\n起因和现象 偶尔会看到线上服务启动的时候第一波流量进来之后，\n迟迟没有任何的响应，同时服务的监控检查接口正常，\n所以 K8S 集群认为服务正常，继续放入流量。\n查看日志基本如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [2020-06-05T13:00:30.7080743+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test [2020-06-05T13:00:30.7081525+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:31.7074253+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR21" started. [2020-06-05T13:00:31.7077051+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:31.7077942+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:32.2103440+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR22" started. [2020-06-05T13:00:32.2118432+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:32.2125894+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-ba&#39;lan&#39;ce does not match a supported file type [2020-06-05T13:00:33.2223942+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR23" started. [2020-06-05T13:00:33.2238736+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:33.2243808+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:34.2177528+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR24" started. [2020-06-05T13:00:34.2189073+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:34.2193483+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:35.2169806+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR25" started. [2020-06-05T13:00:35.2178259+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:35.2181055+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:36.2183025+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR26" started. [2020-06-05T13:00:36.2195050+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:36.2199702+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:37.2373822+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR27" started. 引发的几种后果 客户端调用超时 经过了 30S 甚至更长时间后看到大量的数据库连接被初始化，然后开始集中式返回。\n'><title>一次依赖注入不慎引发的一连串事故</title><link rel=canonical href=https://liguobao.github.io/p/%E4%B8%80%E6%AC%A1%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E4%B8%8D%E6%85%8E%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E8%BF%9E%E4%B8%B2%E4%BA%8B%E6%95%85/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="一次依赖注入不慎引发的一连串事故"><meta property='og:description' content='一次依赖注入不慎引发的一连串事故。\n起因和现象 偶尔会看到线上服务启动的时候第一波流量进来之后，\n迟迟没有任何的响应，同时服务的监控检查接口正常，\n所以 K8S 集群认为服务正常，继续放入流量。\n查看日志基本如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [2020-06-05T13:00:30.7080743+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test [2020-06-05T13:00:30.7081525+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:31.7074253+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR21" started. [2020-06-05T13:00:31.7077051+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:31.7077942+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:32.2103440+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR22" started. [2020-06-05T13:00:32.2118432+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:32.2125894+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-ba&#39;lan&#39;ce does not match a supported file type [2020-06-05T13:00:33.2223942+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR23" started. [2020-06-05T13:00:33.2238736+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:33.2243808+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:34.2177528+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR24" started. [2020-06-05T13:00:34.2189073+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:34.2193483+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:35.2169806+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR25" started. [2020-06-05T13:00:35.2178259+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:35.2181055+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:36.2183025+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR26" started. [2020-06-05T13:00:36.2195050+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:36.2199702+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:37.2373822+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR27" started. 引发的几种后果 客户端调用超时 经过了 30S 甚至更长时间后看到大量的数据库连接被初始化，然后开始集中式返回。\n'><meta property='og:url' content='https://liguobao.github.io/p/%E4%B8%80%E6%AC%A1%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E4%B8%8D%E6%85%8E%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E8%BF%9E%E4%B8%B2%E4%BA%8B%E6%95%85/'><meta property='og:site_name' content='人生删除指南'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='DI'><meta property='article:tag' content='依赖注入'><meta property='article:tag' content='.NET Core'><meta property='article:tag' content='异步编程'><meta property='article:published_time' content='2020-06-07T00:00:00+00:00'><meta property='article:modified_time' content='2020-06-07T00:00:00+00:00'><meta name=twitter:title content="一次依赖注入不慎引发的一连串事故"><meta name=twitter:description content='一次依赖注入不慎引发的一连串事故。\n起因和现象 偶尔会看到线上服务启动的时候第一波流量进来之后，\n迟迟没有任何的响应，同时服务的监控检查接口正常，\n所以 K8S 集群认为服务正常，继续放入流量。\n查看日志基本如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [2020-06-05T13:00:30.7080743+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test [2020-06-05T13:00:30.7081525+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:31.7074253+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR21" started. [2020-06-05T13:00:31.7077051+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:31.7077942+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:32.2103440+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR22" started. [2020-06-05T13:00:32.2118432+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:32.2125894+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-ba&#39;lan&#39;ce does not match a supported file type [2020-06-05T13:00:33.2223942+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR23" started. [2020-06-05T13:00:33.2238736+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:33.2243808+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:34.2177528+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR24" started. [2020-06-05T13:00:34.2189073+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:34.2193483+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:35.2169806+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR25" started. [2020-06-05T13:00:35.2178259+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:35.2181055+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:36.2183025+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR26" started. [2020-06-05T13:00:36.2195050+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance [2020-06-05T13:00:36.2199702+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type [2020-06-05T13:00:37.2373822+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id "0HM09A1MAAR27" started. 引发的几种后果 客户端调用超时 经过了 30S 甚至更长时间后看到大量的数据库连接被初始化，然后开始集中式返回。\n'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/zhihu-lgb_hu_b21b612b464d8faa.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>人生删除指南</a></h1><h2 class=site-description>liguobao</h2></div></header><ol class=menu-social><li><a href=https://github.com/liguobao target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/Liguobao2049 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.zhihu.com/people/codelover target=_blank title=知乎 rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/liguobao-resume/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>About</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://liguobao.github.io/ selected>简体中文</option><option value=https://liguobao.github.io/english/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#起因和现象>起因和现象</a><ol><li><a href=#引发的几种后果>引发的几种后果</a><ol><li><a href=#客户端调用超时>客户端调用超时</a></li><li><a href=#数据库连接暴涨>数据库连接暴涨</a></li><li><a href=#引发服务雪崩效应服务不可用>引发服务“雪崩”效应，服务不可用</a></li></ol></li></ol></li><li><a href=#排查问题>排查问题</a><ol><li><a href=#数据库的问题->数据库的问题 ？</a></li><li><a href=#数据库驱动或者-ef-core-框架的问题>数据库驱动或者 EF Core 框架的问题？</a></li><li><a href=#究竟数据库驱动有没有问题>究竟数据库驱动有没有问题？</a></li></ol></li><li><a href=#某种猜测>某种猜测</a><ol><li><a href=#肯定是有什么奇怪的行为阻塞了当前服务进程>肯定是有什么奇怪的行为阻塞了当前服务进程，</a></li><li><a href=#导致数据库连接的日志也没有输出>导致数据库连接的日志也没有输出。</a></li><li><a href=#锁-异步等同步资源初始化问题>锁？ 异步等同步？资源初始化问题？</a></li><li><a href=#插曲>插曲</a></li></ol></li><li><a href=#开始锁定问题>开始锁定问题</a><ol><li><a href=#中间件导致的吗>中间件导致的吗？</a></li><li><a href=#自定义-filters-导致的吗>自定义 filters 导致的吗？</a></li><li><a href=#尝试使用-ptrace>尝试使用 ptrace</a><ol><li><a href=#speedscopechromium>speedscope/chromium</a></li></ol></li><li><a href=#chrome-performance>Chrome Performance</a><ol><li><a href=#performwaitcallback>PerformWaitCallback</a></li><li><a href=#调用链信息>调用链信息</a></li></ol></li><li><a href=#这是一个-资源阻塞问题产生的问题>这是一个 “资源阻塞问题”产生的问题</a></li></ol></li><li><a href=#控制变量实践>控制变量实践</a><ol><li><a href=#挪接口代码>挪接口代码</a></li><li><a href=#account-balance-有什么神奇的东西吗>account-balance 有什么神奇的东西吗？</a></li></ol></li><li><a href=#原来是-redis-的锅>原来是 Redis 的锅？</a><ol><li><a href=#还有更优的写法吗>还有更优的写法吗？</a></li></ol></li><li><a href=#复盘>复盘</a></li><li><a href=#几个通用的小技巧>几个通用的小技巧</a></li><li><a href=#相关资料>相关资料</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E4%B8%80%E6%AC%A1%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E4%B8%8D%E6%85%8E%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E8%BF%9E%E4%B8%B2%E4%BA%8B%E6%95%85/>一次依赖注入不慎引发的一连串事故</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 07, 2020</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 11 分钟</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://liguobao.github.io/english/p/a-di-misstep-that-cascaded-into-startup-incidents/ class=link>English</a></div></footer></div></header><section class=article-content><p>一次依赖注入不慎引发的一连串事故。</p><h2 id=起因和现象>起因和现象</h2><p>偶尔会看到线上服务启动的时候第一波流量进来之后，</p><p>迟迟没有任何的响应，同时服务的监控检查接口正常，</p><p>所以 K8S 集群认为服务正常，继续放入流量。</p><p>查看日志基本如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[2020-06-05T13:00:30.7080743+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test
</span></span><span class=line><span class=cl>[2020-06-05T13:00:30.7081525+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type
</span></span><span class=line><span class=cl>[2020-06-05T13:00:31.7074253+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id &#34;0HM09A1MAAR21&#34; started.
</span></span><span class=line><span class=cl>[2020-06-05T13:00:31.7077051+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance
</span></span><span class=line><span class=cl>[2020-06-05T13:00:31.7077942+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type
</span></span><span class=line><span class=cl>[2020-06-05T13:00:32.2103440+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id &#34;0HM09A1MAAR22&#34; started.
</span></span><span class=line><span class=cl>[2020-06-05T13:00:32.2118432+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance
</span></span><span class=line><span class=cl>[2020-06-05T13:00:32.2125894+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-ba&#39;lan&#39;ce does not match a supported file type
</span></span><span class=line><span class=cl>[2020-06-05T13:00:33.2223942+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id &#34;0HM09A1MAAR23&#34; started.
</span></span><span class=line><span class=cl>[2020-06-05T13:00:33.2238736+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance
</span></span><span class=line><span class=cl>[2020-06-05T13:00:33.2243808+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type
</span></span><span class=line><span class=cl>[2020-06-05T13:00:34.2177528+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id &#34;0HM09A1MAAR24&#34; started.
</span></span><span class=line><span class=cl>[2020-06-05T13:00:34.2189073+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance
</span></span><span class=line><span class=cl>[2020-06-05T13:00:34.2193483+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type
</span></span><span class=line><span class=cl>[2020-06-05T13:00:35.2169806+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id &#34;0HM09A1MAAR25&#34; started.
</span></span><span class=line><span class=cl>[2020-06-05T13:00:35.2178259+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance
</span></span><span class=line><span class=cl>[2020-06-05T13:00:35.2181055+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type
</span></span><span class=line><span class=cl>[2020-06-05T13:00:36.2183025+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id &#34;0HM09A1MAAR26&#34; started.
</span></span><span class=line><span class=cl>[2020-06-05T13:00:36.2195050+00:00 Microsoft.AspNetCore.Hosting.Diagnostics INF] Request starting HTTP/1.0 GET http://172.16.2.52/v1/user/test/account-balance
</span></span><span class=line><span class=cl>[2020-06-05T13:00:36.2199702+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG] The request path /v1/user/test/account-balance does not match a supported file type
</span></span><span class=line><span class=cl>[2020-06-05T13:00:37.2373822+00:00 Microsoft.AspNetCore.Server.Kestrel DBG] Connection id &#34;0HM09A1MAAR27&#34; started.
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=引发的几种后果>引发的几种后果</h3><h4 id=客户端调用超时>客户端调用超时</h4><p>经过了 30S 甚至更长时间后看到大量的数据库连接被初始化，然后开始集中式返回。</p><p>此时可能对于客户端调用来说这一批请求都是超时的，</p><p>严重影响用户体验和某些依赖于此的其他接口。</p><h4 id=数据库连接暴涨>数据库连接暴涨</h4><p>因为同时进入大量数据库查询请求触发数据库 DbContextPool 大量创建，</p><p>连接数随之暴涨，数据库查询性能急速下降，可能引发其他的应用问题。</p><h4 id=引发服务雪崩效应服务不可用>引发服务“雪崩”效应，服务不可用</h4><p>请求堆积的情况下，</p><p>health-check 接口响应异常，</p><p>导致 k8s 主动重启服务，重启后继续上述情况，</p><p>不断恶化最后导致服务不可用。</p><hr><h2 id=排查问题>排查问题</h2><h3 id=数据库的问题->数据库的问题 ？</h3><p>当然，首先怀疑的就是数据库了。</p><p>存在性能瓶颈？慢查询导致不响应？发布期间存在其他的异常？</p><p>这类的问题都意义排查起来了。</p><p>最后发现，</p><p>这种情况发生的时候，数据库监控里面一片祥和。</p><p>数据库 IO、CPU、内存都正常，</p><p>连接数暴涨是这种情况发生的时候带来的，</p><p>而不是连接数暴涨之后导致了此情况。</p><h3 id=数据库驱动或者-ef-core-框架的问题>数据库驱动或者 EF Core 框架的问题？</h3><p>是的，</p><p>这个怀疑一直都存在于脑海中。</p><p>最终，</p><p>昨天带着“被挨骂的情况”去问了下“Pomelo.EntityFrameworkCore.MySql”的作者。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>春天的熊 18:34:08
</span></span><span class=line><span class=cl>柚子啊，我这边的.NET Core服务刚起来，建立MySQL连接的时候好慢，然后同一批请求可能无法正常响应，这个有什么好的解决思路吗？
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:34:29
</span></span><span class=line><span class=cl>Min Pool Size = 200
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:34:32
</span></span><span class=line><span class=cl>放连接字符串里
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>春天的熊 18:34:53
</span></span><span class=line><span class=cl>这个字段支持了吗？
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:35:07
</span></span><span class=line><span class=cl>一直都支持
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>春天的熊 18:35:56
</span></span><span class=line><span class=cl>等等，      public static IServiceCollection AddDbContextPool&lt;TContext&gt;([NotNullAttribute] this IServiceCollection serviceCollection, [NotNullAttribute] Action&lt;DbContextOptionsBuilder&gt; optionsAction, int poolSize = 128) where TContext : DbContext;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>春天的熊 18:36:13
</span></span><span class=line><span class=cl>这里不是默认最大的128么？
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:36:18
</span></span><span class=line><span class=cl>你这个pool size是dbcontext的
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:36:21
</span></span><span class=line><span class=cl>我说的是mysql连接字符串的
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:36:28
</span></span><span class=line><span class=cl>dbcontext的pool有什么用
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>春天的熊 18:43:13
</span></span><span class=line><span class=cl>我问个讨打的问题，dbcontext 是具体的链接实例，EF用的，Min Pool Size 指的是这一个实例上面的连接池吗“？
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:44:07
</span></span><span class=line><span class=cl>你在说什么。。。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:45:58
</span></span><span class=line><span class=cl>放到mysql的连接字符串上
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:46:14
</span></span><span class=line><span class=cl>这样第一次调用MySqlConnection的时候就会建立200个连接
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>春天的熊 18:46:56
</span></span><span class=line><span class=cl>默认是多少来的？100吗？
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:48:33
</span></span><span class=line><span class=cl>0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:48:40
</span></span><span class=line><span class=cl>max默认是100
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:52:50
</span></span><span class=line><span class=cl>DbContextPool要解决的问题你都没搞清楚
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>春天的熊 18:53:23
</span></span><span class=line><span class=cl>DbContextPool要解决的是尽量不去重复创建DbContext
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:53:34
</span></span><span class=line><span class=cl>为什么不要重复创建DbContext
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>春天的熊 18:53:50
</span></span><span class=line><span class=cl>因为每个DbContext创建的代价很高，而且很慢
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:54:01
</span></span><span class=line><span class=cl>创建DbContext有什么代价
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:54:03
</span></span><span class=line><span class=cl>哪里慢了
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:54:06
</span></span><span class=line><span class=cl>都是毫秒级的
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:54:20
</span></span><span class=line><span class=cl>他的代价不在于创建 而在于回收
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Yuko丶柚子 18:54:25
</span></span><span class=line><span class=cl>DbContextPool要解决的问题是 因为DbContext属于较大的对象，而且是频繁被new，而且经常失去引用导致GC频繁工作。
</span></span></code></pre></td></tr></table></div></div><p>Yuko 大大说的情况感觉会是一个思路，</p><p>所以第一反应就是加了参数控制连接池。</p><p>不过，无果。</p><p>5 个实例，</p><p>有 3 个实例正常启动，</p><p>2 个实例会重复“雪崩”效应，最终无法正常启动。</p><p>这个尝试操作重复了好多次，</p><p>根据文档和 Yuko 大大指导继续加了不少 MySQL 链接参数，</p><p>最后，</p><p>重新学习了一波链接参数的优化意义，</p><p>无果。</p><hr><h3 id=究竟数据库驱动有没有问题>究竟数据库驱动有没有问题？</h3><p>没什么好的思路了，</p><p>远程到容器里面 Debug 基本不太现实（重新打包 + 容器化打包 + k8s + 人肉和服务器垮大洋），</p><p>要不，试试把日志登录调节到 Debug 看看所有的行为？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Using&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;Serilog.Sinks.Console&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;MinimumLevel&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Default&#34;</span><span class=p>:</span> <span class=s2>&#34;Debug&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Override&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Microsoft&#34;</span><span class=p>:</span> <span class=s2>&#34;Debug&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;WriteTo&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Name&#34;</span><span class=p>:</span> <span class=s2>&#34;Console&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Args&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;outputTemplate&#34;</span><span class=p>:</span> <span class=s2>&#34;[{Timestamp:o}  {SourceContext} {Level:u3}] {Message:lj}{NewLine}{Exception}&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，这个事情没有直接在正常的生产环境执行。</p><p>这里是使用新配置，重新起新实例来操作。</p><p>然后我们看到程序启动的时候执行 EFMigration 的时候，</p><p>程序和整个数据库交互的完整日志。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4147202</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Connection</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Opening</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=s1>&#39;aliyun-rds&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4159970</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Connection</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Opened</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=s1>&#39;a&#39;</span><span class=n>li</span><span class=s1>&#39;yun&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4161172</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Command</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Executing</span><span class=w> </span><span class=n>DbCommand</span><span class=w> </span><span class=p>[</span><span class=n>Parameters</span><span class=o>=</span><span class=p>[],</span><span class=w> </span><span class=n>CommandType</span><span class=o>=</span><span class=s1>&#39;Text&#39;</span><span class=p>,</span><span class=w> </span><span class=n>CommandTimeout</span><span class=o>=</span><span class=s1>&#39;30&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>INFORMATION_SCHEMA</span><span class=p>.</span><span class=kp>TABLES</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>TABLE_SCHEMA</span><span class=o>=</span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>TABLE_NAME</span><span class=o>=</span><span class=s1>&#39;__EFMigrationsHistory&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4170776</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Command</span><span class=w> </span><span class=n>INF</span><span class=p>]</span><span class=w> </span><span class=n>Executed</span><span class=w> </span><span class=nf>DbCommand</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=n>ms</span><span class=p>)</span><span class=w> </span><span class=p>[</span><span class=n>Parameters</span><span class=o>=</span><span class=p>[],</span><span class=w> </span><span class=n>CommandType</span><span class=o>=</span><span class=s1>&#39;Text&#39;</span><span class=p>,</span><span class=w> </span><span class=n>CommandTimeout</span><span class=o>=</span><span class=s1>&#39;30&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>INFORMATION_SCHEMA</span><span class=p>.</span><span class=kp>TABLES</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>TABLE_SCHEMA</span><span class=o>=</span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>TABLE_NAME</span><span class=o>=</span><span class=s1>&#39;__EFMigrationsHistory&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4171630</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Connection</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Closing</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=s1>&#39;aliyun-rds&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4172458</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Connection</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Closed</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=s1>&#39;aliyun-rds&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4385345</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Command</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Creating</span><span class=w> </span><span class=n>DbCommand</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;ExecuteReader&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4386201</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Command</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Created</span><span class=w> </span><span class=n>DbCommand</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;ExecuteReader&#39;</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=n>ms</span><span class=p>).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4386763</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Connection</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Opening</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=s1>&#39;aliyun-rds&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4400143</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Connection</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Opened</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=s1>&#39;aliyun-rds&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4404529</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Command</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Executing</span><span class=w> </span><span class=n>DbCommand</span><span class=w> </span><span class=p>[</span><span class=n>Parameters</span><span class=o>=</span><span class=p>[],</span><span class=w> </span><span class=n>CommandType</span><span class=o>=</span><span class=s1>&#39;Text&#39;</span><span class=p>,</span><span class=w> </span><span class=n>CommandTimeout</span><span class=o>=</span><span class=s1>&#39;30&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>`</span><span class=n>MigrationId</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>ProductVersion</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>__EFMigrationsHistory</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=n>MigrationId</span><span class=o>`</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4422387</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Command</span><span class=w> </span><span class=n>INF</span><span class=p>]</span><span class=w> </span><span class=n>Executed</span><span class=w> </span><span class=nf>DbCommand</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=n>ms</span><span class=p>)</span><span class=w> </span><span class=p>[</span><span class=n>Parameters</span><span class=o>=</span><span class=p>[],</span><span class=w> </span><span class=n>CommandType</span><span class=o>=</span><span class=s1>&#39;Text&#39;</span><span class=p>,</span><span class=w> </span><span class=n>CommandTimeout</span><span class=o>=</span><span class=s1>&#39;30&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>`</span><span class=n>MigrationId</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>ProductVersion</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>__EFMigrationsHistory</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=n>MigrationId</span><span class=o>`</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4446400</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Command</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=n>was</span><span class=w> </span><span class=n>disposed</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4447422</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Connection</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Closing</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=s1>&#39;aliyun-rds&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>4447975</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=k>Database</span><span class=p>.</span><span class=n>Connection</span><span class=w> </span><span class=n>DBG</span><span class=p>]</span><span class=w> </span><span class=n>Closed</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=s1>&#39;user_pool&#39;</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=s1>&#39;aliyun-rds&#39;</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=mi>2020</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>05</span><span class=n>T12</span><span class=p>:</span><span class=mi>59</span><span class=p>:</span><span class=mi>56</span><span class=p>.</span><span class=mi>5170419</span><span class=o>+</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>EntityFrameworkCore</span><span class=p>.</span><span class=n>Migrations</span><span class=w> </span><span class=n>INF</span><span class=p>]</span><span class=w> </span><span class=n>No</span><span class=w> </span><span class=n>migrations</span><span class=w> </span><span class=n>were</span><span class=w> </span><span class=n>applied</span><span class=p>.</span><span class=w> </span><span class=n>The</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>already</span><span class=w> </span><span class=n>up</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=kt>date</span><span class=p>.</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><p>看到这里的时候，由于发现我们之前对 DbContext 和 DbConnection 的理解不太好，</p><p>想搞清楚究竟是不 db connection 创建的时候有哪些行为，</p><p>于是我们找到了 <a class=link href=https://github.com/dotnet/efcore target=_blank rel=noopener>dotnet/efcore Github </a>的源码开始拜读，</p><p>PS： 源码真香，能看源码真好。</p><p>尝试通过“Opening connection”找到日志的场景。</p><p>想了解这个日志输出的时候代码在做什么样的事情，可能同时会有哪些行为。</p><p>在考虑是不是其他的一些行为导致了上面的服务问题？</p><p>最终在<a class=link href=https://github.com/dotnet/efcore/blob/14f13ef6dfb0aae7e2faedfb0de604070fc5d101/src/EFCore.Relational/Storage/RelationalConnection.cs target=_blank rel=noopener>RelationalConnection.cs</a>确认上面这些数据库相关日志肯定是会输出的，不存在其他的异常行为。</p><p>PS：不用细看，我们认真浏览了代码之后确认 DbContext 正常初始化，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>///     Asynchronously opens the connection to the database.</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;param name=&#34;errorsExpected&#34;&gt; Indicate if the connection errors are expected and should be logged as debug message. &lt;/param&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;param name=&#34;cancellationToken&#34;&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>///     A &lt;see cref=&#34;CancellationToken&#34; /&gt; to observe while waiting for the task to complete.</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/param&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;returns&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>///     A task that represents the asynchronous operation, with a value of &lt;see langword=&#34;true&#34;/&gt; if the connection</span>
</span></span><span class=line><span class=cl>        <span class=cs>///     was actually opened.</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/returns&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=k>virtual</span> <span class=kd>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=kt>bool</span><span class=p>&gt;</span> <span class=n>OpenAsync</span><span class=p>(</span><span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>errorsExpected</span> <span class=p>=</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>DbConnection</span><span class=p>.</span><span class=n>State</span> <span class=p>==</span> <span class=n>ConnectionState</span><span class=p>.</span><span class=n>Broken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>DbConnection</span><span class=p>.</span><span class=n>CloseAsync</span><span class=p>().</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>wasOpened</span> <span class=p>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>DbConnection</span><span class=p>.</span><span class=n>State</span> <span class=p>!=</span> <span class=n>ConnectionState</span><span class=p>.</span><span class=n>Open</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>CurrentTransaction</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=n>CurrentTransaction</span><span class=p>.</span><span class=n>DisposeAsync</span><span class=p>().</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>ClearTransactions</span><span class=p>(</span><span class=n>clearAmbient</span><span class=p>:</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>OpenDbConnectionAsync</span><span class=p>(</span><span class=n>errorsExpected</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>wasOpened</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>_openedCount</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>HandleAmbientTransactions</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>wasOpened</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>async</span> <span class=n>Task</span> <span class=n>OpenDbConnectionAsync</span><span class=p>(</span><span class=kt>bool</span> <span class=n>errorsExpected</span><span class=p>,</span> <span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>startTime</span> <span class=p>=</span> <span class=n>DateTimeOffset</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>stopwatch</span> <span class=p>=</span> <span class=n>Stopwatch</span><span class=p>.</span><span class=n>StartNew</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 日志输出在这里</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>interceptionResult</span>
</span></span><span class=line><span class=cl>                <span class=p>=</span> <span class=k>await</span> <span class=n>Dependencies</span><span class=p>.</span><span class=n>ConnectionLogger</span><span class=p>.</span><span class=n>ConnectionOpeningAsync</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(!</span><span class=n>interceptionResult</span><span class=p>.</span><span class=n>IsSuppressed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=n>DbConnection</span><span class=p>.</span><span class=n>OpenAsync</span><span class=p>(</span><span class=n>cancellationToken</span><span class=p>).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 日志输出在这里</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>Dependencies</span><span class=p>.</span><span class=n>ConnectionLogger</span><span class=p>.</span><span class=n>ConnectionOpenedAsync</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>stopwatch</span><span class=p>.</span><span class=n>Elapsed</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>Dependencies</span><span class=p>.</span><span class=n>ConnectionLogger</span><span class=p>.</span><span class=n>ConnectionErrorAsync</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>startTime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>stopwatch</span><span class=p>.</span><span class=n>Elapsed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>errorsExpected</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>cancellationToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>throw</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>_openedCount</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>_openedInternally</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，我们同时也去看了一眼 <a class=link href=https://mysqlconnector.net/ target=_blank rel=noopener>MySqlConnector</a>的源码，</p><p>确认它自身是维护了数据库连接池的。到这里基本确认不会是数据库驱动导致的上述问题。</p><hr><h2 id=某种猜测>某种猜测</h2><h3 id=肯定是有什么奇怪的行为阻塞了当前服务进程>肯定是有什么奇怪的行为阻塞了当前服务进程，</h3><h3 id=导致数据库连接的日志也没有输出>导致数据库连接的日志也没有输出。</h3><h3 id=锁-异步等同步资源初始化问题>锁？ 异步等同步？资源初始化问题？</h3><p>周五晚上查到了这里已经十一点了，</p><p>于是先下班回家休息了。</p><p>于是，</p><p>周六练完车之后 Call 了一下小伙伴，</p><p>又双双开始了愉快的 Debug。</p><hr><h3 id=插曲>插曲</h3><p>小伙伴海林回公司前发了个朋友圈。</p><p>“ 咋们继续昨天的 bug，</p><p>特此立 flag：修不好直播吃 bug</p><p>反正不是你死就是我亡…”</p><p>我调侃评论说:</p><p>你等下，我打包下代码去楼下打印出来待会当晚饭</p><hr><h2 id=开始锁定问题>开始锁定问题</h2><h3 id=中间件导致的吗>中间件导致的吗？</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[2020-06-05T13:00:35.2181055+00:00 Microsoft.AspNetCore.StaticFiles.StaticFileMiddleware DBG]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The request path /v1/user/test/account-balance does not match a supported file type
</span></span></code></pre></td></tr></table></div></div><p>我们对着这个日志思考了一会人生，</p><p>然后把引用此中间件的代码注释掉了，</p><p>不过，无果。</p><h3 id=自定义-filters-导致的吗>自定义 filters 导致的吗？</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[2020-06-05T13:01:05.3126001+00:00 Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker DBG] Execution plan of exception filters (in the following order): [&#34;None&#34;]
</span></span><span class=line><span class=cl>[2020-06-05T13:01:05.3126391+00:00 Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker DBG] Execution plan of result filters (in the following order): [&#34;Microsoft.AspNetCore.Mvc.ViewFeatures.Filters.SaveTempDataFilter&#34;, &#34;XXX.Filters.HTTPHeaderAttribute (Order: 0)&#34;]
</span></span><span class=line><span class=cl>[2020-06-05T13:01:05.3072206+00:00 Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker DBG] Execution plan of authorization filters (in the following order): [&#34;None&#34;]
</span></span></code></pre></td></tr></table></div></div><p>看到这个日志我们考虑了一下，</p><p>是不是因为 filters 导致了问题。</p><p>毕竟在 HTTPHeaderAttribute 我们还还做了 ThreadLocal&lt;Dictionary&lt;string, string&#187; CurrentXHeaders</p><p>这里怀疑是不是我们的实现存在锁机制导致“假死问题”。</p><p>尝试去掉。</p><p>不过，</p><p>无果。</p><hr><h3 id=尝试使用-ptrace>尝试使用 ptrace</h3><p>没什么很好的头绪了，要不上一下 ptrace 之类的工具跟一下系统调用？</p><p>最早在去年就尝试过使用 ptrace 抓进程数据看系统调用，</p><p>后来升级到.NET Core3.0 之后，官方基于 Events + LTTng 之类的东西做了 dotnet-trace 工具，</p><p>官网说明：<a class=link href=https://docs.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-trace target=_blank rel=noopener>dotnet-trace performance analysis utility</a></p><p>改一下打包扔上去做一个数据收集看看。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Docker data-lang=Docker><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=w> </span><span class=s>mcr.microsoft.com/dotnet/core/sdk:3.1</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s>build-env</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=w> </span><span class=s>/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># copy csproj and restore as distinct layers</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> src/*.csproj ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># copy everything else and build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet publish src -c Release -o /app/out<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># build runtime image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=w> </span><span class=s>mcr.microsoft.com/dotnet/core/aspnet:3.1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># debug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Install .NET Core SDK</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nv>dotnet_sdk_version</span><span class=o>=</span>3.1.100 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> curl -SL --output dotnet.tar.gz https://dotnetcli.azureedge.net/dotnet/Sdk/<span class=nv>$dotnet_sdk_version</span>/dotnet-sdk-<span class=nv>$dotnet_sdk_version</span>-linux-x64.tar.gz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> <span class=nv>dotnet_sha512</span><span class=o>=</span><span class=s1>&#39;5217ae1441089a71103694be8dd5bb3437680f00e263ad28317665d819a92338a27466e7d7a2b1f6b74367dd314128db345fa8fff6e90d0c966dea7a9a43bd21&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$dotnet_sha512</span><span class=s2> dotnet.tar.gz&#34;</span> <span class=p>|</span> sha512sum -c - <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> rm -rf /usr/share/dotnet <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> rm -rf /usr/bin/dotnet <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> mkdir -p /usr/share/dotnet <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> tar -ozxf dotnet.tar.gz -C /usr/share/dotnet <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> rm dotnet.tar.gz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=c1># Trigger first run experience by running arbitrary cmd</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=o>&amp;&amp;</span> dotnet help<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet tool install --global dotnet-trace<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet tool install -g dotnet-dump<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet tool install --global dotnet-counters<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$PATH</span><span class=s2>:/root/.dotnet/tools&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># end debug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=w> </span><span class=s>/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build-env /app/out .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;Your-APP.dll&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><hr><p>更新发布，等待服务正常启动之后，</p><p>使用 ab -c 300 -n 3000 &lsquo;http://172.16.2.52/v1/user/test/account-balance&rsquo; 模拟 300 个用户同时请求，</p><p>使得程序进入上述的“假死状态”。</p><p>接着立即进入容器，执行&rsquo;dotnet-trace collect -p 1&rsquo; 开始收集日志。</p><p>最后拿到了一份大概 13M trace.nettrace 数据, 这个文件是 PerView 支持的格式，</p><p>在 MacOS 或者 Linux 上无法使用。</p><p>好在 dotnet-trace convert 可以将 trace.nettrace 转换成 speedscope/chromium 两种格式。</p><h4 id=speedscopechromium>speedscope/chromium</h4><ul><li><p><a class=link href=https://github.com/jlfwong/speedscope target=_blank rel=noopener>speedscope:A fast, interactive web-based viewer for performance profiles.</a></p></li><li><p><a class=link href=https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/ target=_blank rel=noopener>chrome-devtools evaluate-performance</a></p></li><li><p><a class=link href=https://zhuanlan.zhihu.com/p/29879682 target=_blank rel=noopener>全新 Chrome Devtool Performance 使用指南</a></p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>$dotnet</span>-trace convert 20200606-1753-trace.nettrace.txt  --format Speedscope
</span></span><span class=line><span class=cl><span class=nv>$dotnet</span>-trace convert 20200606-1753-trace.nettrace.txt --format chromium
</span></span><span class=line><span class=cl><span class=nv>$speedscope</span> 20200606-1753-trace.nettrace.speedscope.json
</span></span></code></pre></td></tr></table></div></div><p>然后，炸鸡了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>➜</span>  <span class=n>Downloads</span> <span class=n>speedscope</span> <span class=mi>20200606</span><span class=o>-</span><span class=mf>1625.</span><span class=n>trace</span><span class=o>.</span><span class=n>speedscope</span><span class=o>.</span><span class=n>json</span>
</span></span><span class=line><span class=cl><span class=n>Error</span><span class=p>:</span> <span class=n>Cannot</span> <span class=n>create</span> <span class=n>a</span> <span class=n>string</span> <span class=n>longer</span> <span class=n>than</span> <span class=mh>0x3fffffe7</span> <span class=n>characters</span>
</span></span><span class=line><span class=cl>    <span class=n>at</span> <span class=ne>Object</span><span class=o>.</span><span class=n>slice</span> <span class=p>(</span><span class=n>buffer</span><span class=o>.</span><span class=n>js</span><span class=p>:</span><span class=mi>652</span><span class=p>:</span><span class=mi>37</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>at</span> <span class=n>Buffer</span><span class=o>.</span><span class=n>toString</span> <span class=p>(</span><span class=n>buffer</span><span class=o>.</span><span class=n>js</span><span class=p>:</span><span class=mi>800</span><span class=p>:</span><span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>at</span> <span class=n>main</span> <span class=p>(</span><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>liguobao</span><span class=o>/.</span><span class=n>nvm</span><span class=o>/</span><span class=n>versions</span><span class=o>/</span><span class=n>node</span><span class=o>/</span><span class=n>v12</span><span class=o>.</span><span class=mf>16.2</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>node_modules</span><span class=o>/</span><span class=n>speedscope</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>cli</span><span class=o>.</span><span class=n>js</span><span class=p>:</span><span class=mi>69</span><span class=p>:</span><span class=mi>39</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>at</span> <span class=n>processTicksAndRejections</span> <span class=p>(</span><span class=n>internal</span><span class=o>/</span><span class=n>process</span><span class=o>/</span><span class=n>task_queues</span><span class=o>.</span><span class=n>js</span><span class=p>:</span><span class=mi>97</span><span class=p>:</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Usage</span><span class=p>:</span> <span class=n>speedscope</span> <span class=p>[</span><span class=n>filepath</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>If</span> <span class=n>invoked</span> <span class=n>with</span> <span class=n>no</span> <span class=n>arguments</span><span class=p>,</span> <span class=n>will</span> <span class=n>open</span> <span class=n>a</span> <span class=n>local</span> <span class=n>copy</span> <span class=n>of</span> <span class=n>speedscope</span> <span class=ow>in</span> <span class=n>your</span> <span class=n>default</span> <span class=n>browser</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>Once</span> <span class=n>open</span><span class=p>,</span> <span class=n>you</span> <span class=n>can</span> <span class=n>browse</span> <span class=k>for</span> <span class=n>a</span> <span class=n>profile</span> <span class=n>to</span> <span class=n>import</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>If</span> <span class=o>-</span> <span class=n>is</span> <span class=n>used</span> <span class=n>as</span> <span class=n>the</span> <span class=n>filepath</span><span class=p>,</span> <span class=n>will</span> <span class=n>read</span> <span class=n>from</span> <span class=n>stdin</span> <span class=n>instead</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>cat</span> <span class=o>/</span><span class=n>path</span><span class=o>/</span><span class=n>to</span><span class=o>/</span><span class=n>profile</span> <span class=o>|</span> <span class=n>speedscope</span> <span class=o>-</span>
</span></span></code></pre></td></tr></table></div></div><p>哦， Buffer.toString 炸鸡了。</p><p>看一眼 20200606-1625.trace.speedscope.json 多大?</p><p>900M。</p><p>牛逼。</p><p>那换 Chrome performance 看看。</p><p><img src=http://qiniu.house2048.cn/chrome-performance.png loading=lazy alt=chrome-performance></p><p>手动装载一下 20200606-1753-trace.nettrace.chromium.json 看看。</p><p>等下，20200606-1753-trace.nettrace.chromium.json 这货多大？</p><p>哦，4G。应该没事，Intel NUC 主机内存空闲 20G，吃掉 4G 完全是没有问题的。</p><p><img src=http://qiniu.house2048.cn/chrome_performance_load_json.png loading=lazy alt=chrome_performance_load_json></p><p>看着进度条加载，看着内存涨起来，</p><p>然后&mldr;Chrome 控制台奔溃。再见再见，原来大家彼此完全没有信任了。</p><p>唉，再来一次，把文件控制在 5M 左右看看。</p><p>最后，把 20200606-1753-trace.nettrace.chromium.json 控制在 1.5G 了，</p><p>终于可以正常加载起来了。</p><hr><h3 id=chrome-performance>Chrome Performance</h3><p>首先， 我们看到监控里面有一堆的线程</p><p><img src=http://qiniu.house2048.cn/Chrome%20performance_threading_74.png loading=lazy alt=Chrome%20performance_threading_74></p><p>随便选一个线程看看它做撒,选择 Call Tree 之后 点点点点点。</p><p><img src=http://qiniu.house2048.cn/Chrome%20performance_74_call_tree.png loading=lazy alt=20performance_74_call_tree></p><p>从调用栈能看到 整个线程当前状态是“PerformWaitCallback”</p><p>整个操作应该的开头应该是</p><p>Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Infrastructure.KestrelConnection.System.Threading.IThreadPoolWorkItem.Execute()</p><p>PS： Kestrel (<a class=link href=https://github.com/aspnet/KestrelHttpServer target=_blank rel=noopener>https://github.com/aspnet/KestrelHttpServer</a>) is a lightweight cross-platform web server that supports .NET Core and runs on multiple platforms such as Linux, macOS, and Windows. Kestrel is fully written in .Net core. It is based on libuv which is a multi-platform asynchronous eventing library.</p><p>PS 人话： .NET Core 内置的 HTTP Server，和 Spring Boot 中的 tomcat 组件类似</p><p>很正常，说明请求正常到了我们的服务里面了。</p><p>再看一下剩下的调用链信息。</p><p><img src=http://qiniu.house2048.cn/dotnet-call-tree-di.png loading=lazy alt=dotnet-call-tree-di></p><p>简要的调用信息日志在这里：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(!!0&amp;)
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Infrastructure.KestrelConnection+&lt;ExecuteAsync&gt;d__32.MoveNext()
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Server.Kestrel.Core.Internal.HttpConnectionMiddleware`1[System.__Canon].OnConnectionAsync(class Microsoft.AspNetCore.Connections.ConnectionContext)   Microsoft.AspNetCore.Server.Kestrel.Core.Internal.HttpConnection.ProcessRequestsAsync(class Microsoft.AspNetCore.Hosting.Server.IHttpApplication`1&lt;!!0&gt;)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start(!!0&amp;)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(!!0&amp;)
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Server.Kestrel.Core.Internal.HttpConnection+&lt;ProcessRequestsAsync&gt;d__12`1[System.__Canon].MoveNext()
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequestsAsync(class Microsoft.AspNetCore.Hosting.Server.IHttpApplication`1&lt;!!0&gt;)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start(!!0&amp;)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(!!0&amp;)
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol+&lt;ProcessRequestsAsync&gt;d__216`1[System.__Canon].MoveNext()
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests(class Microsoft.AspNetCore.Hosting.Server.IHttpApplication`1&lt;!!0&gt;)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start(!!0&amp;)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(!!0&amp;)
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol+&lt;ProcessRequests&gt;d__217`1[System.__Canon].MoveNext()
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Hosting.HostingApplication.ProcessRequestAsync(class Context)
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.HostFiltering.HostFilteringMiddleware.Invoke(class Microsoft.AspNetCore.Http.HttpContext)
</span></span><span class=line><span class=cl>UserCenter.ErrorHandlingMiddleware.Invoke(class Microsoft.AspNetCore.Http.HttpContext)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start(!!0&amp;)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(!!0&amp;)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>e.StaticFiles.StaticFileMiddleware.Invoke(class Microsoft.AspNetCore.Http.HttpContext)
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Builder.UseMiddlewareExtensions+&lt;&gt;c__DisplayClass4_1.&lt;UseMiddleware&gt;b__2(class Microsoft.AspNetCore.Http.HttpContext)
</span></span><span class=line><span class=cl>dynamicClass.lambda_method(pMT: 00007FB6D3BBE570,class System.Object,pMT: 00007FB6D4739560,pMT: 00007FB6D0BF4F98)
</span></span><span class=line><span class=cl>Microsoft.AspNetCore.Builder.UseMiddlewareExtensions.GetService(class System.IServiceProvider,class System.Type,class System.Type)
</span></span><span class=line><span class=cl>Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngineScope.GetService(class System.Type)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start(!!0&amp;)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor`2[Microsoft.Extensions.DependencyInjection.ServiceLookup.RuntimeResolverContext,System.__Canon].VisitCallSite(class Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceCallSite,!0)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start(!!0&amp;)
</span></span><span class=line><span class=cl>System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start(!!0&amp;)
</span></span></code></pre></td></tr></table></div></div><p>看到这里，其实又有了一些很给力的信息被暴露出来了。</p><hr><h4 id=performwaitcallback>PerformWaitCallback</h4><ul><li>直接字面理解，线程正在执行等待回调</li></ul><h4 id=调用链信息>调用链信息</h4><p>耐心点，把所有的电调用链都展开。</p><p>我们能看到程序已经依次经过了下面几个流程：</p><p>->ProcessRequestsAsync(系统)</p><p>->ErrorHandlingMiddleware(已经加载了自定义的错误中间件)</p><p>-> HostFilteringMiddleware(加载了 Filter 中间件)</p><p>-> Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteVisitor(调用链中的最后一个操作)</p><p>对应最上面的日志来说，</p><p>请求进来，经过了中间件和 Filter 都是没问题的，</p><p>最后在 DependencyInjection（依赖注入） 中没有了踪迹。</p><p>到这里，</p><p>再次验证我们昨天的思路：</p><h3 id=这是一个-资源阻塞问题产生的问题>这是一个 “资源阻塞问题”产生的问题</h3><p>虽然做 ptrace 是想能直接抓到“凶手”的，</p><p>最后发现并没有能跟踪到具体的实现，</p><p>那可咋办呢？</p><h2 id=控制变量实践>控制变量实践</h2><p>已知：</p><ul><li>并发 300 访问 /v1/user/test/account-balance 接口程序会假死</li><li>移除 Filter 中间件不能解决问题</li><li>并发 300 访问 /v1/health 健康检查接口程序正常</li><li>ptrace 信息告诉我们有“东西”在阻塞 DI 容器创建某些实例</li></ul><p>开始控制变量 + 人肉二分查找。</p><h3 id=挪接口代码>挪接口代码</h3><p>/v1/user/test/account-balance 的逻辑是由 AccountService 实现的，</p><p>AccountService 大概依赖四五个其他的 Service 和 DBContext，</p><p>最主要的逻辑是加载用户几个账号，然后计算一下 balance。</p><p>大概代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl><span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl><span class=cs>/// 获取用户的AccountBalance汇总信息</span>
</span></span><span class=line><span class=cl><span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>AccountBalanceStat</span><span class=p>&gt;</span> <span class=n>LoadAccountBalanceStatAsync</span><span class=p>(</span><span class=kt>string</span> <span class=n>owner</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 数据库查询</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>accounts</span> <span class=p>=</span> <span class=k>await</span> <span class=n>_dbContext</span><span class=p>.</span><span class=n>BabelAccounts</span><span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>ac</span> <span class=p>=&gt;</span> <span class=n>ac</span><span class=p>.</span><span class=n>Owner</span> <span class=p>==</span> <span class=n>owner</span><span class=p>).</span><span class=n>ToListAsync</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 内存计算</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ConvertToAccountBalanceStat</span><span class=p>(</span><span class=n>accounts</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>什么都不改，直接把代码 CP 到 Health 接口测一下。</p><p>神奇，300 并发抗住了。</p><p>结论：</p><ul><li>上面这一段代码并不会导致服务僵死</li><li>数据库驱动没有问题，DbContext 没有问题，数据库资源使用没有问题</li><li>当前并不会触发 DI 容器异常， 问题出在 /v1/user/test/account-balance 初始化</li></ul><h3 id=account-balance-有什么神奇的东西吗>account-balance 有什么神奇的东西吗？</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl><span class=cs>/// 查询用户的Brick账号余额</span>
</span></span><span class=line><span class=cl><span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl><span class=na>[HttpGet(&#34;v1/user/{owner}/account-balance&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>[SwaggerResponse(200, &#34;获取成功&#34;, typeof(AccountBrickStat))]</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>IActionResult</span><span class=p>&gt;</span> <span class=n>GetAccountBricks</span><span class=p>(</span>
</span></span><span class=line><span class=cl><span class=na>    [FromRoute, SwaggerParameter(&#34;所有者&#34;, Required = true)]</span> <span class=kt>string</span> <span class=n>owner</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=p>=</span> <span class=k>await</span> <span class=n>_userService</span><span class=p>.</span><span class=n>FindOwnerAsync</span><span class=p>(</span><span class=n>owner</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Ok</span><span class=p>(</span><span class=k>new</span> <span class=p>{</span> <span class=n>data</span> <span class=p>=</span> <span class=k>await</span> <span class=n>_accountService</span><span class=p>.</span><span class=n>LoadAccountAsync</span><span class=p>(</span><span class=n>owner</span><span class=p>),</span> <span class=n>code</span> <span class=p>=</span> <span class=m>0</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们刚刚验证了 LoadAccountAsync 的代码是没有问题的，</p><p>要不 UserService DI 有问题，要不 AccountService DI 有问题。</p><p>把 UserService 加入到 HealthController 中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>HealthController</span><span class=p>(</span><span class=n>UserService</span> <span class=n>userService</span><span class=p>,</span> <span class=n>UserPoolDataContext</span> <span class=n>dbContext</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_dbContext</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>_userService</span><span class=p>=</span> <span class=n>userService</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Bool。</p><p>300 并发没有撑住，程序僵死啦。</p><p>完美，</p><p>问题应该在 UserService DI 初始化了。</p><p>接下来就是一个个验证 UserService DI 需要的资源，</p><p>EmailSDK 没有问题，</p><p>HTTPHeaderTools 没有问题，</p><p>UserActivityLogService 没有问题。</p><p>RedisClient&mldr;
RedisClient&mldr;
RedisClient&mldr;</p><p>OK
OK
Ok</p><p>复现炸鸡了。</p><hr><h2 id=原来是-redis-的锅>原来是 Redis 的锅？</h2><p>是，</p><p>也不是。</p><p>先看下我们 RedisClient 是怎么使用的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C# data-lang=C#><span class=line><span class=cl><span class=c1>// startup.cs 注入了单例的ConnectionMultiplexer</span>
</span></span><span class=line><span class=cl><span class=c1>// 程序启动的时候会调用InitRedis</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=k>void</span> <span class=n>InitRedis</span><span class=p>(</span><span class=n>IServiceCollection</span> <span class=n>services</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddSingleton</span><span class=p>&lt;</span><span class=n>ConnectionMultiplexer</span><span class=p>,</span> <span class=n>ConnectionMultiplexer</span><span class=p>&gt;(</span><span class=n>factory</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ConfigurationOptions</span> <span class=n>options</span> <span class=p>=</span> <span class=n>ConfigurationOptions</span><span class=p>.</span><span class=n>Parse</span><span class=p>(</span><span class=n>Configuration</span><span class=p>[</span><span class=s>&#34;RedisConnectionString&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>options</span><span class=p>.</span><span class=n>SyncTimeout</span> <span class=p>=</span> <span class=m>10</span> <span class=p>*</span> <span class=m>10000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ConnectionMultiplexer</span><span class=p>.</span><span class=n>Connect</span><span class=p>(</span><span class=n>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//RedisClient.cs 通过构造函数传入</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>RedisClient</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=n>ConnectionMultiplexer</span> <span class=n>_redisMultiplexer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=n>ILogger</span><span class=p>&lt;</span><span class=n>RedisClient</span><span class=p>&gt;</span> <span class=n>_logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>RedisClient</span><span class=p>(</span><span class=n>ConnectionMultiplexer</span> <span class=n>redisMultiplexer</span><span class=p>,</span> <span class=n>ILogger</span><span class=p>&lt;</span><span class=n>RedisService</span><span class=p>&gt;</span> <span class=n>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_redisMultiplexer</span> <span class=p>=</span> <span class=n>redisMultiplexer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>_logger</span> <span class=p>=</span> <span class=n>logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DI 初始化 RedisClient 实例的时候，</p><p>需要执行 ConnectionMultiplexer.Connect 方法，</p><p>ConnectionMultiplexer.Connect 是同步阻塞的。</p><p>ConnectionMultiplexer.Connect 是同步阻塞的。</p><p>ConnectionMultiplexer.Connect 是同步阻塞的。</p><p>一切都能解释了。</p><p>怎么改？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl><span class=c1>// InitRedis 直接把链接创建好，然后直接注入到IServiceCollection中</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=k>void</span> <span class=n>InitRedis</span><span class=p>(</span><span class=n>IServiceCollection</span> <span class=n>services</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ConfigurationOptions</span> <span class=n>options</span> <span class=p>=</span> <span class=n>ConfigurationOptions</span><span class=p>.</span><span class=n>Parse</span><span class=p>(</span><span class=n>Configuration</span><span class=p>[</span><span class=s>&#34;RedisConnectionString&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=p>.</span><span class=n>SyncTimeout</span> <span class=p>=</span> <span class=m>10</span> <span class=p>*</span> <span class=m>10000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>redisConnectionMultiplexer</span> <span class=p>=</span> <span class=n>ConnectionMultiplexer</span><span class=p>.</span><span class=n>Connect</span><span class=p>(</span><span class=n>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddSingleton</span><span class=p>(</span><span class=n>redisConnectionMultiplexer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=p>.</span><span class=n>Information</span><span class=p>(</span><span class=s>&#34;InitRedis success.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>发布验证，</p><p>开门放并发 300 + 3000 请求。</p><p>完美抗住，丝一般顺滑。</p><h3 id=还有更优的写法吗>还有更优的写法吗？</h3><ul><li>看了下微软 Cache 中间件源码，更好的做法应该是通过信号量+异步锁来创建 Redis 链接，下来再研究一下</li><li>数据库中可能也存在类似的问题，不过当前会在 Startup 中戳一下数据库连接，应该问题不大。</li></ul><h2 id=复盘>复盘</h2><p>程序启动的时候依赖注入容器同步初始化 Redis 可能很慢(几秒甚至更长)的时候，</p><p>其他的资源都在同步等待它初始化好，</p><p>最终导致请求堆积，引起程序雪崩效应。</p><p>Redis 初始化过慢并不每次都发生， 所以之前服务也只是偶发。</p><p>DI 初始化 Redis 连接的时候，redis 打来连接还是个同步的方法，</p><p>这种情况下还可能发生异步请求中等待同步资源产生阻塞问题。</p><p>同时还需要排查使用其他外部资源的时候是否会触发同类问题。</p><hr><h2 id=几个通用的小技巧>几个通用的小技巧</h2><ul><li><p>ptrace 对此类问题分析很有意义，不同语言框架都有类似的实现</p></li><li><p>同步、异步概念的原理和实现都要了解，这个有利于理解一些奇奇怪怪的问题</p></li><li><p>火焰图、Chrome dev Performance 、speedscope 都是好东西</p></li><li><p>Debug 日志能给更多的信息，在隔离生产的情况下大胆使用</p></li><li><p>这辈子都不可能看源码的，写写 CURD 多美丽？源码真香，源码真牛逼。</p></li><li><p>控制变量验证，大胆假设，小心求证，人肉二分查，先怀疑自己再怀疑框架</p></li><li><p>搞事的时候不要自己一个人，有 Bug 一定要拉上小伙伴一起吃</p></li></ul><hr><h2 id=相关资料>相关资料</h2><ul><li><p><a class=link href=https://www.ibm.com/developerworks/cn/linux/l-cn-embedded-ptrace/index.html target=_blank rel=noopener>IBM Developer ptrace 嵌入式系统中进程间通信的监视方法</a></p></li><li><p><a class=link href=https://www.jianshu.com/p/d6686cb72f68 target=_blank rel=noopener>分析进程调用 pstack 和 starce</a></p></li><li><p><a class=link href=https://wangchujiang.com/linux-command/c/pstack.html target=_blank rel=noopener>pstack 显示每个进程的栈跟踪</a></p></li><li><p><a class=link href=https://docs.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-trace target=_blank rel=noopener>微软：dotnet-trace performance analysis utility</a></p></li><li><p><a class=link href=https://zhuanlan.zhihu.com/p/29879682 target=_blank rel=noopener>知乎：全新 Chrome Devtool Performance 使用指南</a></p></li><li><p><a class=link href=https://github.com/jlfwong/speedscope target=_blank rel=noopener>speedscope A fast, interactive web-based viewer for performance profiles.</a></p></li><li><p><a class=link href=https://www.cnblogs.com/duanxz/p/5487576.html target=_blank rel=noopener>jdk 工具之 jstack(Java Stack Trace)</a></p></li><li><p><a class=link href=https://ruanyifeng.com/blog/2017/09/flame-graph.html target=_blank rel=noopener>阮一峰:如何读懂火焰图？</a></p></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/di/>DI</a>
<a href=/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/>依赖注入</a>
<a href=/tags/.net-core/>.NET Core</a>
<a href=/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/>异步编程</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><script src=https://utteranc.es/client.js repo=liguobao/liguobao.github.io issue-term=title crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 人生删除指南</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>