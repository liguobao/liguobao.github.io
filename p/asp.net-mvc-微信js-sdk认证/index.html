<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='ASP.NET MVC 微信JS-SDK认证 写在前面 前阵子因为有个项目需要做微信自定义分享功能，因而去研究了下微信JS-SDK相关知识。\n此文做个简单的记(tu)录(cao)&mldr;\n开始 所有的东西都从文档开始:微信JSSDK说明文档\n项目需要用到的是分享接口 不过使用微信JS-SDK之前，需要做JS接口认证。\n认证如下：\n步骤一：绑定域名\n步骤二：引入JS文件\n步骤三：通过config接口注入权限验证配置\n步骤四：通过ready接口处理成功验证\n步骤五：通过error接口处理失败验证\n步骤一中允许使用域名/子域名，只要xx.com/xxx.txt或者xx.com/mp/xxx.txt能访问就好。域名认证通过之后，此域名下的所有端口的网站都可以使用JS-SDK。\n步骤二没什么问题，略过。\n步骤三最磨人，下面单独讲解。\nconfig接口注入权限验证配置 先来一段说明：\n所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用 （同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用, 目前Android微信客户端不支持pushState的H5新特性， 所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。\n1 2 3 4 5 6 7 8 9 wx.config({ debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来， //若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。 appId: &#39;&#39;, // 必填，公众号的唯一标识 timestamp: , // 必填，生成签名的时间戳 nonceStr: &#39;&#39;, // 必填，生成签名的随机串 signature: &#39;&#39;,// 必填，签名，见附录1 jsApiList: [] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2 }); 看到这里肯定懵逼了，这是都什么鬼&mldr;怎么玩啊。\n提示我们去看附录1&mldr;看完之后总结如下：\n使用config接口注入权限验证配置，重点是生成合法的signatrue 生成signature需要通过appid和secret获取token 时间戳和调用接口URL必不可少 此操作需要服务端完成，不能使用客户端实现 整个过程变成：\n通过appid和secret获取access_token，接着使用token获取jsapi_ticket；\n拿到jsapi_ticket之后，把jsapi_ticket、时间戳、随机字符串、接口调用页面URL 拼接成完整字符串，使用sha1算法加密得到signature。\n最后返回至页面，在wx.config里面填入appid，上一步的时间戳timestamp，上一部的随机字符串、sha1拿到的signature，想要使用的JS接口。\n废话少说，直接上代码吧。\n代码时间 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 public class WeiXinController : Controller { public static readonly string appid = System.Web.Configuration.WebConfigurationManager.AppSettings["wxappid"]; public static readonly string secret = System.Web.Configuration.WebConfigurationManager.AppSettings["wxsecret"]; public static readonly bool isDedug = System.Web.Configuration.WebConfigurationManager.AppSettings["IsDebug"] =="true"; public static string _ticket = ""; public static DateTime _lastTimestamp; public ActionResult Info(string url,string noncestr) { if (string.IsNullOrEmpty(_ticket) || _lastTimestamp == null || (_lastTimestamp - DateTime.Now).Milliseconds > 7200) { var resultString = HTTPHelper.GetHTMLByURL("https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=" + appid + "&amp;secret=" + secret); dynamic resultValue = JsonConvert.DeserializeObject<dynamic>(resultString); if (resultValue == null || resultValue.access_token == null || resultValue.access_token.Value == null) { return Json(new { issuccess = false, error = "获取token失败" }); } var token = resultValue.access_token.Value; resultString = HTTPHelper.GetHTMLByURL ("https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=" + token + "&amp;type=jsapi"); dynamic ticketValue = JsonConvert.DeserializeObject<dynamic>(resultString); if (ticketValue == null || ticketValue.errcode == null || ticketValue.errcode.Value != 0 || ticketValue.ticket == null) return Json(new { issuccess = false, error = "获取ticketValue失败" }); _ticket = ticketValue.ticket.Value; _lastTimestamp = DateTime.Now; var timestamp = GetTimeStamp(); var hexString = string.Format("jsapi_ticket={0}&amp;noncestr={3}&amp;timestamp={1}&amp;url={2}", _ticket, timestamp, url,noncestr); return Json(new { issuccess = true, sha1value = GetSHA1Value(hexString), timestamp = timestamp, url = url, appid = appid, debug=isDedug, tiket=_ticket }); } else { var timestamp = GetTimeStamp(); var hexString = string.Format("jsapi_ticket={0}&amp;noncestr=1234567890123456&amp;timestamp={1}&amp;url={2}", _ticket, timestamp, url); return Json(new { issuccess = true, sha1value = GetSHA1Value(hexString), timestamp = timestamp, url = url, appid = appid, debug = isDedug,tiket = _ticket }); } } private string GetSHA1Value(string sourceString) { var hash = SHA1.Create().ComputeHash(Encoding.UTF8.GetBytes(sourceString)); return string.Join("", hash.Select(b => b.ToString("x2")).ToArray()); } private static string GetTimeStamp() { TimeSpan ts = DateTime.Now - new DateTime(1970, 1, 1, 0, 0, 0, 0); return Convert.ToInt64(ts.TotalSeconds).ToString(); } } public class HTTPHelper { public static string GetHTMLByURL(string url) { string htmlCode = string.Empty; try { HttpWebRequest webRequest = (System.Net.HttpWebRequest)System.Net.WebRequest.Create(url); webRequest.Timeout = 30000; webRequest.Method = "GET"; webRequest.UserAgent = "Mozilla/4.0"; webRequest.Headers.Add("Accept-Encoding", "gzip, deflate"); HttpWebResponse webResponse = (System.Net.HttpWebResponse)webRequest.GetResponse(); //获取目标网站的编码格式 string contentype = webResponse.Headers["Content-Type"]; Regex regex = new Regex("charset\\\\s*=\\\\s*[\\\\W]?\\\\s*([\\\\w-]+)", RegexOptions.IgnoreCase); if (webResponse.ContentEncoding.ToLower() == "gzip")//如果使用了GZip则先解压 { using (System.IO.Stream streamReceive = webResponse.GetResponseStream()) { using (var zipStream = new System.IO.Compression.GZipStream(streamReceive, System.IO.Compression.CompressionMode.Decompress)) { //匹配编码格式 if (regex.IsMatch(contentype)) { Encoding ending = Encoding.GetEncoding (regex.Match(contentype).Groups[1].Value.Trim()); using (StreamReader sr = new System.IO.StreamReader(zipStream, ending)) { htmlCode = sr.ReadToEnd(); } } else { using (StreamReader sr = new System.IO.StreamReader(zipStream, Encoding.UTF8)) { htmlCode = sr.ReadToEnd(); } } } } } else { using (System.IO.Stream streamReceive = webResponse.GetResponseStream()) { var encoding = Encoding.Default; if (contentype.Contains("utf")) encoding = Encoding.UTF8; using (System.IO.StreamReader sr = new System.IO.StreamReader(streamReceive, encoding)) { htmlCode = sr.ReadToEnd(); } } } return htmlCode; } catch (Exception ex) { return ""; } } } PS：这里要注意缓存一下_ticket（即access_token），照微信文档说的，access_token两个小时内有效，不需要频繁调用。而且获取access_token的接口有调用次数的限制，如果超过了次数，就不允许调用了。\n'><title>ASP.NET MVC 微信JS-SDK认证</title><link rel=canonical href=https://liguobao.github.io/p/asp.net-mvc-%E5%BE%AE%E4%BF%A1js-sdk%E8%AE%A4%E8%AF%81/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="ASP.NET MVC 微信JS-SDK认证"><meta property='og:description' content='ASP.NET MVC 微信JS-SDK认证 写在前面 前阵子因为有个项目需要做微信自定义分享功能，因而去研究了下微信JS-SDK相关知识。\n此文做个简单的记(tu)录(cao)&mldr;\n开始 所有的东西都从文档开始:微信JSSDK说明文档\n项目需要用到的是分享接口 不过使用微信JS-SDK之前，需要做JS接口认证。\n认证如下：\n步骤一：绑定域名\n步骤二：引入JS文件\n步骤三：通过config接口注入权限验证配置\n步骤四：通过ready接口处理成功验证\n步骤五：通过error接口处理失败验证\n步骤一中允许使用域名/子域名，只要xx.com/xxx.txt或者xx.com/mp/xxx.txt能访问就好。域名认证通过之后，此域名下的所有端口的网站都可以使用JS-SDK。\n步骤二没什么问题，略过。\n步骤三最磨人，下面单独讲解。\nconfig接口注入权限验证配置 先来一段说明：\n所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用 （同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用, 目前Android微信客户端不支持pushState的H5新特性， 所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。\n1 2 3 4 5 6 7 8 9 wx.config({ debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来， //若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。 appId: &#39;&#39;, // 必填，公众号的唯一标识 timestamp: , // 必填，生成签名的时间戳 nonceStr: &#39;&#39;, // 必填，生成签名的随机串 signature: &#39;&#39;,// 必填，签名，见附录1 jsApiList: [] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2 }); 看到这里肯定懵逼了，这是都什么鬼&mldr;怎么玩啊。\n提示我们去看附录1&mldr;看完之后总结如下：\n使用config接口注入权限验证配置，重点是生成合法的signatrue 生成signature需要通过appid和secret获取token 时间戳和调用接口URL必不可少 此操作需要服务端完成，不能使用客户端实现 整个过程变成：\n通过appid和secret获取access_token，接着使用token获取jsapi_ticket；\n拿到jsapi_ticket之后，把jsapi_ticket、时间戳、随机字符串、接口调用页面URL 拼接成完整字符串，使用sha1算法加密得到signature。\n最后返回至页面，在wx.config里面填入appid，上一步的时间戳timestamp，上一部的随机字符串、sha1拿到的signature，想要使用的JS接口。\n废话少说，直接上代码吧。\n代码时间 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 public class WeiXinController : Controller { public static readonly string appid = System.Web.Configuration.WebConfigurationManager.AppSettings["wxappid"]; public static readonly string secret = System.Web.Configuration.WebConfigurationManager.AppSettings["wxsecret"]; public static readonly bool isDedug = System.Web.Configuration.WebConfigurationManager.AppSettings["IsDebug"] =="true"; public static string _ticket = ""; public static DateTime _lastTimestamp; public ActionResult Info(string url,string noncestr) { if (string.IsNullOrEmpty(_ticket) || _lastTimestamp == null || (_lastTimestamp - DateTime.Now).Milliseconds > 7200) { var resultString = HTTPHelper.GetHTMLByURL("https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=" + appid + "&amp;secret=" + secret); dynamic resultValue = JsonConvert.DeserializeObject<dynamic>(resultString); if (resultValue == null || resultValue.access_token == null || resultValue.access_token.Value == null) { return Json(new { issuccess = false, error = "获取token失败" }); } var token = resultValue.access_token.Value; resultString = HTTPHelper.GetHTMLByURL ("https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=" + token + "&amp;type=jsapi"); dynamic ticketValue = JsonConvert.DeserializeObject<dynamic>(resultString); if (ticketValue == null || ticketValue.errcode == null || ticketValue.errcode.Value != 0 || ticketValue.ticket == null) return Json(new { issuccess = false, error = "获取ticketValue失败" }); _ticket = ticketValue.ticket.Value; _lastTimestamp = DateTime.Now; var timestamp = GetTimeStamp(); var hexString = string.Format("jsapi_ticket={0}&amp;noncestr={3}&amp;timestamp={1}&amp;url={2}", _ticket, timestamp, url,noncestr); return Json(new { issuccess = true, sha1value = GetSHA1Value(hexString), timestamp = timestamp, url = url, appid = appid, debug=isDedug, tiket=_ticket }); } else { var timestamp = GetTimeStamp(); var hexString = string.Format("jsapi_ticket={0}&amp;noncestr=1234567890123456&amp;timestamp={1}&amp;url={2}", _ticket, timestamp, url); return Json(new { issuccess = true, sha1value = GetSHA1Value(hexString), timestamp = timestamp, url = url, appid = appid, debug = isDedug,tiket = _ticket }); } } private string GetSHA1Value(string sourceString) { var hash = SHA1.Create().ComputeHash(Encoding.UTF8.GetBytes(sourceString)); return string.Join("", hash.Select(b => b.ToString("x2")).ToArray()); } private static string GetTimeStamp() { TimeSpan ts = DateTime.Now - new DateTime(1970, 1, 1, 0, 0, 0, 0); return Convert.ToInt64(ts.TotalSeconds).ToString(); } } public class HTTPHelper { public static string GetHTMLByURL(string url) { string htmlCode = string.Empty; try { HttpWebRequest webRequest = (System.Net.HttpWebRequest)System.Net.WebRequest.Create(url); webRequest.Timeout = 30000; webRequest.Method = "GET"; webRequest.UserAgent = "Mozilla/4.0"; webRequest.Headers.Add("Accept-Encoding", "gzip, deflate"); HttpWebResponse webResponse = (System.Net.HttpWebResponse)webRequest.GetResponse(); //获取目标网站的编码格式 string contentype = webResponse.Headers["Content-Type"]; Regex regex = new Regex("charset\\\\s*=\\\\s*[\\\\W]?\\\\s*([\\\\w-]+)", RegexOptions.IgnoreCase); if (webResponse.ContentEncoding.ToLower() == "gzip")//如果使用了GZip则先解压 { using (System.IO.Stream streamReceive = webResponse.GetResponseStream()) { using (var zipStream = new System.IO.Compression.GZipStream(streamReceive, System.IO.Compression.CompressionMode.Decompress)) { //匹配编码格式 if (regex.IsMatch(contentype)) { Encoding ending = Encoding.GetEncoding (regex.Match(contentype).Groups[1].Value.Trim()); using (StreamReader sr = new System.IO.StreamReader(zipStream, ending)) { htmlCode = sr.ReadToEnd(); } } else { using (StreamReader sr = new System.IO.StreamReader(zipStream, Encoding.UTF8)) { htmlCode = sr.ReadToEnd(); } } } } } else { using (System.IO.Stream streamReceive = webResponse.GetResponseStream()) { var encoding = Encoding.Default; if (contentype.Contains("utf")) encoding = Encoding.UTF8; using (System.IO.StreamReader sr = new System.IO.StreamReader(streamReceive, encoding)) { htmlCode = sr.ReadToEnd(); } } } return htmlCode; } catch (Exception ex) { return ""; } } } PS：这里要注意缓存一下_ticket（即access_token），照微信文档说的，access_token两个小时内有效，不需要频繁调用。而且获取access_token的接口有调用次数的限制，如果超过了次数，就不允许调用了。\n'><meta property='og:url' content='https://liguobao.github.io/p/asp.net-mvc-%E5%BE%AE%E4%BF%A1js-sdk%E8%AE%A4%E8%AF%81/'><meta property='og:site_name' content='人生删除指南'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='.net'><meta property='article:tag' content='javascript'><meta property='article:tag' content><meta property='article:published_time' content='2016-11-01T00:00:00+00:00'><meta property='article:modified_time' content='2016-11-01T00:00:00+00:00'><meta name=twitter:title content="ASP.NET MVC 微信JS-SDK认证"><meta name=twitter:description content='ASP.NET MVC 微信JS-SDK认证 写在前面 前阵子因为有个项目需要做微信自定义分享功能，因而去研究了下微信JS-SDK相关知识。\n此文做个简单的记(tu)录(cao)&mldr;\n开始 所有的东西都从文档开始:微信JSSDK说明文档\n项目需要用到的是分享接口 不过使用微信JS-SDK之前，需要做JS接口认证。\n认证如下：\n步骤一：绑定域名\n步骤二：引入JS文件\n步骤三：通过config接口注入权限验证配置\n步骤四：通过ready接口处理成功验证\n步骤五：通过error接口处理失败验证\n步骤一中允许使用域名/子域名，只要xx.com/xxx.txt或者xx.com/mp/xxx.txt能访问就好。域名认证通过之后，此域名下的所有端口的网站都可以使用JS-SDK。\n步骤二没什么问题，略过。\n步骤三最磨人，下面单独讲解。\nconfig接口注入权限验证配置 先来一段说明：\n所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用 （同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用, 目前Android微信客户端不支持pushState的H5新特性， 所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。\n1 2 3 4 5 6 7 8 9 wx.config({ debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来， //若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。 appId: &#39;&#39;, // 必填，公众号的唯一标识 timestamp: , // 必填，生成签名的时间戳 nonceStr: &#39;&#39;, // 必填，生成签名的随机串 signature: &#39;&#39;,// 必填，签名，见附录1 jsApiList: [] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2 }); 看到这里肯定懵逼了，这是都什么鬼&mldr;怎么玩啊。\n提示我们去看附录1&mldr;看完之后总结如下：\n使用config接口注入权限验证配置，重点是生成合法的signatrue 生成signature需要通过appid和secret获取token 时间戳和调用接口URL必不可少 此操作需要服务端完成，不能使用客户端实现 整个过程变成：\n通过appid和secret获取access_token，接着使用token获取jsapi_ticket；\n拿到jsapi_ticket之后，把jsapi_ticket、时间戳、随机字符串、接口调用页面URL 拼接成完整字符串，使用sha1算法加密得到signature。\n最后返回至页面，在wx.config里面填入appid，上一步的时间戳timestamp，上一部的随机字符串、sha1拿到的signature，想要使用的JS接口。\n废话少说，直接上代码吧。\n代码时间 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 public class WeiXinController : Controller { public static readonly string appid = System.Web.Configuration.WebConfigurationManager.AppSettings["wxappid"]; public static readonly string secret = System.Web.Configuration.WebConfigurationManager.AppSettings["wxsecret"]; public static readonly bool isDedug = System.Web.Configuration.WebConfigurationManager.AppSettings["IsDebug"] =="true"; public static string _ticket = ""; public static DateTime _lastTimestamp; public ActionResult Info(string url,string noncestr) { if (string.IsNullOrEmpty(_ticket) || _lastTimestamp == null || (_lastTimestamp - DateTime.Now).Milliseconds > 7200) { var resultString = HTTPHelper.GetHTMLByURL("https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=" + appid + "&amp;secret=" + secret); dynamic resultValue = JsonConvert.DeserializeObject<dynamic>(resultString); if (resultValue == null || resultValue.access_token == null || resultValue.access_token.Value == null) { return Json(new { issuccess = false, error = "获取token失败" }); } var token = resultValue.access_token.Value; resultString = HTTPHelper.GetHTMLByURL ("https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=" + token + "&amp;type=jsapi"); dynamic ticketValue = JsonConvert.DeserializeObject<dynamic>(resultString); if (ticketValue == null || ticketValue.errcode == null || ticketValue.errcode.Value != 0 || ticketValue.ticket == null) return Json(new { issuccess = false, error = "获取ticketValue失败" }); _ticket = ticketValue.ticket.Value; _lastTimestamp = DateTime.Now; var timestamp = GetTimeStamp(); var hexString = string.Format("jsapi_ticket={0}&amp;noncestr={3}&amp;timestamp={1}&amp;url={2}", _ticket, timestamp, url,noncestr); return Json(new { issuccess = true, sha1value = GetSHA1Value(hexString), timestamp = timestamp, url = url, appid = appid, debug=isDedug, tiket=_ticket }); } else { var timestamp = GetTimeStamp(); var hexString = string.Format("jsapi_ticket={0}&amp;noncestr=1234567890123456&amp;timestamp={1}&amp;url={2}", _ticket, timestamp, url); return Json(new { issuccess = true, sha1value = GetSHA1Value(hexString), timestamp = timestamp, url = url, appid = appid, debug = isDedug,tiket = _ticket }); } } private string GetSHA1Value(string sourceString) { var hash = SHA1.Create().ComputeHash(Encoding.UTF8.GetBytes(sourceString)); return string.Join("", hash.Select(b => b.ToString("x2")).ToArray()); } private static string GetTimeStamp() { TimeSpan ts = DateTime.Now - new DateTime(1970, 1, 1, 0, 0, 0, 0); return Convert.ToInt64(ts.TotalSeconds).ToString(); } } public class HTTPHelper { public static string GetHTMLByURL(string url) { string htmlCode = string.Empty; try { HttpWebRequest webRequest = (System.Net.HttpWebRequest)System.Net.WebRequest.Create(url); webRequest.Timeout = 30000; webRequest.Method = "GET"; webRequest.UserAgent = "Mozilla/4.0"; webRequest.Headers.Add("Accept-Encoding", "gzip, deflate"); HttpWebResponse webResponse = (System.Net.HttpWebResponse)webRequest.GetResponse(); //获取目标网站的编码格式 string contentype = webResponse.Headers["Content-Type"]; Regex regex = new Regex("charset\\\\s*=\\\\s*[\\\\W]?\\\\s*([\\\\w-]+)", RegexOptions.IgnoreCase); if (webResponse.ContentEncoding.ToLower() == "gzip")//如果使用了GZip则先解压 { using (System.IO.Stream streamReceive = webResponse.GetResponseStream()) { using (var zipStream = new System.IO.Compression.GZipStream(streamReceive, System.IO.Compression.CompressionMode.Decompress)) { //匹配编码格式 if (regex.IsMatch(contentype)) { Encoding ending = Encoding.GetEncoding (regex.Match(contentype).Groups[1].Value.Trim()); using (StreamReader sr = new System.IO.StreamReader(zipStream, ending)) { htmlCode = sr.ReadToEnd(); } } else { using (StreamReader sr = new System.IO.StreamReader(zipStream, Encoding.UTF8)) { htmlCode = sr.ReadToEnd(); } } } } } else { using (System.IO.Stream streamReceive = webResponse.GetResponseStream()) { var encoding = Encoding.Default; if (contentype.Contains("utf")) encoding = Encoding.UTF8; using (System.IO.StreamReader sr = new System.IO.StreamReader(streamReceive, encoding)) { htmlCode = sr.ReadToEnd(); } } } return htmlCode; } catch (Exception ex) { return ""; } } } PS：这里要注意缓存一下_ticket（即access_token），照微信文档说的，access_token两个小时内有效，不需要频繁调用。而且获取access_token的接口有调用次数的限制，如果超过了次数，就不允许调用了。\n'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/zhihu-lgb_hu_b21b612b464d8faa.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>人生删除指南</a></h1><h2 class=site-description>liguobao</h2></div></header><ol class=menu-social><li><a href=https://github.com/liguobao target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/Liguobao2049 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.zhihu.com/people/codelover target=_blank title=知乎 rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/liguobao-resume/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>About</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://liguobao.github.io/ selected>简体中文</option><option value=https://liguobao.github.io/english/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#写在前面>写在前面</a></li><li><a href=#开始>开始</a><ol><li><a href=#config接口注入权限验证配置>config接口注入权限验证配置</a></li><li><a href=#代码时间>代码时间</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/asp.net-mvc-%E5%BE%AE%E4%BF%A1js-sdk%E8%AE%A4%E8%AF%81/>ASP.NET MVC 微信JS-SDK认证</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 01, 2016</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 3 分钟</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://liguobao.github.io/english/p/wechat-js-sdk-integration-notes/ class=link>English</a></div></footer></div></header><section class=article-content><h1 id=aspnet-mvc-微信js-sdk认证>ASP.NET MVC 微信JS-SDK认证</h1><h2 id=写在前面>写在前面</h2><p>前阵子因为有个项目需要做微信自定义分享功能，因而去研究了下微信JS-SDK相关知识。</p><p>此文做个简单的记(tu)录(cao)&mldr;</p><h2 id=开始>开始</h2><p>所有的东西都从文档开始:<a class=link href=http://mp.weixin.qq.com/wiki/11/74ad127cc054f6b80759c40f77ec03db.html target=_blank rel=noopener>微信JSSDK说明文档</a></p><p><img src=http://7xread.com1.z0.glb.clouddn.com/44b1232e-9311-4abb-9200-6dd4936d7c47 loading=lazy alt=分享接口></p><p>项目需要用到的是<a class=link href=http://mp.weixin.qq.com/wiki/11/74ad127cc054f6b80759c40f77ec03db.html#.E5.88.86.E4.BA.AB.E6.8E.A5.E5.8F.A3 target=_blank rel=noopener>分享接口</a> 不过使用微信JS-SDK之前，需要做JS接口认证。</p><p>认证如下：</p><p>步骤一：绑定域名</p><p>步骤二：引入JS文件</p><p>步骤三：通过config接口注入权限验证配置</p><p>步骤四：通过ready接口处理成功验证</p><p>步骤五：通过error接口处理失败验证</p><p>步骤一中允许使用域名/子域名，只要xx.com/xxx.txt或者xx.com/mp/xxx.txt能访问就好。域名认证通过之后，此域名下的所有端口的网站都可以使用JS-SDK。</p><p>步骤二没什么问题，略过。</p><p>步骤三最磨人，下面单独讲解。</p><h3 id=config接口注入权限验证配置>config接口注入权限验证配置</h3><p>先来一段说明：</p><p>所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用
（同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用,
目前Android微信客户端不支持pushState的H5新特性，
所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>wx</span><span class=p>.</span><span class=nx>config</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>debug</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// 开启调试模式,调用的所有api的返回值会在客户端alert出来，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>appId</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=c1>// 必填，公众号的唯一标识
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>timestamp</span><span class=o>:</span> <span class=p>,</span> <span class=c1>// 必填，生成签名的时间戳
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>nonceStr</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=c1>// 必填，生成签名的随机串
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>signature</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span><span class=c1>// 必填，签名，见附录1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>jsApiList</span><span class=o>:</span> <span class=p>[]</span> <span class=c1>// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>看到这里肯定懵逼了，这是都什么鬼&mldr;怎么玩啊。</p><p>提示我们去看附录1&mldr;看完之后总结如下：</p><ol><li>使用config接口注入权限验证配置，重点是生成合法的signatrue</li><li>生成signature需要通过appid和secret获取token</li><li>时间戳和调用接口URL必不可少</li><li>此操作需要服务端完成，不能使用客户端实现</li></ol><p>整个过程变成：</p><ol><li><p>通过appid和secret获取access_token，接着使用token获取jsapi_ticket；</p></li><li><p>拿到jsapi_ticket之后，把jsapi_ticket、时间戳、随机字符串、接口调用页面URL 拼接成完整字符串，使用sha1算法加密得到signature。</p></li><li><p>最后返回至页面，在wx.config里面填入appid，上一步的时间戳timestamp，上一部的随机字符串、sha1拿到的signature，想要使用的JS接口。</p></li></ol><p>废话少说，直接上代码吧。</p><h3 id=代码时间>代码时间</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>class</span> <span class=nc>WeiXinController</span> <span class=p>:</span> <span class=n>Controller</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=kt>string</span> <span class=n>appid</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=p>.</span><span class=n>Web</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>WebConfigurationManager</span><span class=p>.</span><span class=n>AppSettings</span><span class=p>[</span><span class=s>&#34;wxappid&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=kt>string</span> <span class=n>secret</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=p>.</span><span class=n>Web</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>WebConfigurationManager</span><span class=p>.</span><span class=n>AppSettings</span><span class=p>[</span><span class=s>&#34;wxsecret&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=kt>bool</span> <span class=n>isDedug</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=p>.</span><span class=n>Web</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>WebConfigurationManager</span><span class=p>.</span><span class=n>AppSettings</span><span class=p>[</span><span class=s>&#34;IsDebug&#34;</span><span class=p>]</span> <span class=p>==</span><span class=s>&#34;true&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=kt>string</span> <span class=n>_ticket</span> <span class=p>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=n>DateTime</span> <span class=n>_lastTimestamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>ActionResult</span> <span class=n>Info</span><span class=p>(</span><span class=kt>string</span> <span class=n>url</span><span class=p>,</span><span class=kt>string</span> <span class=n>noncestr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>_ticket</span><span class=p>)</span> <span class=p>||</span> 
</span></span><span class=line><span class=cl>            <span class=n>_lastTimestamp</span> <span class=p>==</span> <span class=kc>null</span> <span class=p>||</span> <span class=p>(</span><span class=n>_lastTimestamp</span> <span class=p>-</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>).</span><span class=n>Milliseconds</span> <span class=p>&gt;</span> <span class=m>7200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>resultString</span> <span class=p>=</span> <span class=n>HTTPHelper</span><span class=p>.</span><span class=n>GetHTMLByURL</span><span class=p>(</span><span class=s>&#34;https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>+</span> <span class=n>appid</span> <span class=p>+</span> <span class=s>&#34;&amp;secret=&#34;</span> <span class=p>+</span> <span class=n>secret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=kt>dynamic</span> <span class=n>resultValue</span> <span class=p>=</span> <span class=n>JsonConvert</span><span class=p>.</span><span class=n>DeserializeObject</span><span class=p>&lt;</span><span class=kt>dynamic</span><span class=p>&gt;(</span><span class=n>resultString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>resultValue</span> <span class=p>==</span> <span class=kc>null</span> <span class=p>||</span> <span class=n>resultValue</span><span class=p>.</span><span class=n>access_token</span> <span class=p>==</span> <span class=kc>null</span> 
</span></span><span class=line><span class=cl>                <span class=p>||</span> <span class=n>resultValue</span><span class=p>.</span><span class=n>access_token</span><span class=p>.</span><span class=n>Value</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>Json</span><span class=p>(</span><span class=k>new</span> <span class=p>{</span> <span class=n>issuccess</span> <span class=p>=</span> <span class=kc>false</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>error</span> <span class=p>=</span> <span class=s>&#34;获取token失败&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>token</span> <span class=p>=</span> <span class=n>resultValue</span><span class=p>.</span><span class=n>access_token</span><span class=p>.</span><span class=n>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>resultString</span> <span class=p>=</span> <span class=n>HTTPHelper</span><span class=p>.</span><span class=n>GetHTMLByURL</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=s>&#34;https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=&#34;</span> <span class=p>+</span> 
</span></span><span class=line><span class=cl>                <span class=n>token</span> <span class=p>+</span> <span class=s>&#34;&amp;type=jsapi&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=kt>dynamic</span> <span class=n>ticketValue</span> <span class=p>=</span> <span class=n>JsonConvert</span><span class=p>.</span><span class=n>DeserializeObject</span><span class=p>&lt;</span><span class=kt>dynamic</span><span class=p>&gt;(</span><span class=n>resultString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>ticketValue</span> <span class=p>==</span> <span class=kc>null</span> <span class=p>||</span> <span class=n>ticketValue</span><span class=p>.</span><span class=n>errcode</span> <span class=p>==</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>                <span class=p>||</span> <span class=n>ticketValue</span><span class=p>.</span><span class=n>errcode</span><span class=p>.</span><span class=n>Value</span> <span class=p>!=</span> <span class=m>0</span> <span class=p>||</span> <span class=n>ticketValue</span><span class=p>.</span><span class=n>ticket</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>Json</span><span class=p>(</span><span class=k>new</span> <span class=p>{</span> <span class=n>issuccess</span> <span class=p>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>error</span> <span class=p>=</span> <span class=s>&#34;获取ticketValue失败&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=n>_ticket</span> <span class=p>=</span> <span class=n>ticketValue</span><span class=p>.</span><span class=n>ticket</span><span class=p>.</span><span class=n>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>_lastTimestamp</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>timestamp</span> <span class=p>=</span> <span class=n>GetTimeStamp</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>hexString</span> <span class=p>=</span> <span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;jsapi_ticket={0}&amp;noncestr={3}&amp;timestamp={1}&amp;url={2}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>_ticket</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span><span class=n>noncestr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>Json</span><span class=p>(</span><span class=k>new</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>issuccess</span> <span class=p>=</span> <span class=kc>true</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>sha1value</span> <span class=p>=</span> <span class=n>GetSHA1Value</span><span class=p>(</span><span class=n>hexString</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span> <span class=p>=</span> <span class=n>timestamp</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>url</span> <span class=p>=</span> <span class=n>url</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>appid</span> <span class=p>=</span> <span class=n>appid</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>debug</span><span class=p>=</span><span class=n>isDedug</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>tiket</span><span class=p>=</span><span class=n>_ticket</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>timestamp</span> <span class=p>=</span> <span class=n>GetTimeStamp</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>hexString</span> <span class=p>=</span> <span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;jsapi_ticket={0}&amp;noncestr=1234567890123456&amp;timestamp={1}&amp;url={2}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>_ticket</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>Json</span><span class=p>(</span><span class=k>new</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>                    <span class=n>issuccess</span> <span class=p>=</span> <span class=kc>true</span><span class=p>,</span> <span class=n>sha1value</span> <span class=p>=</span> <span class=n>GetSHA1Value</span><span class=p>(</span><span class=n>hexString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span> <span class=p>=</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>url</span> <span class=p>=</span> <span class=n>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>appid</span> <span class=p>=</span> <span class=n>appid</span><span class=p>,</span> <span class=n>debug</span> <span class=p>=</span> <span class=n>isDedug</span><span class=p>,</span><span class=n>tiket</span> <span class=p>=</span> <span class=n>_ticket</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>string</span> <span class=n>GetSHA1Value</span><span class=p>(</span><span class=kt>string</span> <span class=n>sourceString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>hash</span> <span class=p>=</span> <span class=n>SHA1</span><span class=p>.</span><span class=n>Create</span><span class=p>().</span><span class=n>ComputeHash</span><span class=p>(</span><span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>sourceString</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kt>string</span><span class=p>.</span><span class=n>Join</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>hash</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>b</span> <span class=p>=&gt;</span> <span class=n>b</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;x2&#34;</span><span class=p>)).</span><span class=n>ToArray</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=kt>string</span> <span class=n>GetTimeStamp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>TimeSpan</span> <span class=n>ts</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span> <span class=p>-</span> <span class=k>new</span> <span class=n>DateTime</span><span class=p>(</span><span class=m>1970</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=m>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Convert</span><span class=p>.</span><span class=n>ToInt64</span><span class=p>(</span><span class=n>ts</span><span class=p>.</span><span class=n>TotalSeconds</span><span class=p>).</span><span class=n>ToString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>class</span> <span class=nc>HTTPHelper</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=kt>string</span> <span class=n>GetHTMLByURL</span><span class=p>(</span><span class=kt>string</span> <span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>string</span> <span class=n>htmlCode</span> <span class=p>=</span> <span class=kt>string</span><span class=p>.</span><span class=n>Empty</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>HttpWebRequest</span> <span class=n>webRequest</span> <span class=p>=</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>HttpWebRequest</span><span class=p>)</span><span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>WebRequest</span><span class=p>.</span><span class=n>Create</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>webRequest</span><span class=p>.</span><span class=n>Timeout</span> <span class=p>=</span> <span class=m>30000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>webRequest</span><span class=p>.</span><span class=n>Method</span> <span class=p>=</span> <span class=s>&#34;GET&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>webRequest</span><span class=p>.</span><span class=n>UserAgent</span> <span class=p>=</span> <span class=s>&#34;Mozilla/4.0&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>webRequest</span><span class=p>.</span><span class=n>Headers</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=s>&#34;Accept-Encoding&#34;</span><span class=p>,</span> <span class=s>&#34;gzip, deflate&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>HttpWebResponse</span> <span class=n>webResponse</span> <span class=p>=</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>HttpWebResponse</span><span class=p>)</span><span class=n>webRequest</span><span class=p>.</span><span class=n>GetResponse</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>//获取目标网站的编码格式</span>
</span></span><span class=line><span class=cl>                <span class=kt>string</span> <span class=n>contentype</span> <span class=p>=</span> <span class=n>webResponse</span><span class=p>.</span><span class=n>Headers</span><span class=p>[</span><span class=s>&#34;Content-Type&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=n>Regex</span> <span class=n>regex</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Regex</span><span class=p>(</span><span class=s>&#34;charset\\s*=\\s*[\\W]?\\s*([\\w-]+)&#34;</span><span class=p>,</span> <span class=n>RegexOptions</span><span class=p>.</span><span class=n>IgnoreCase</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>webResponse</span><span class=p>.</span><span class=n>ContentEncoding</span><span class=p>.</span><span class=n>ToLower</span><span class=p>()</span> <span class=p>==</span> <span class=s>&#34;gzip&#34;</span><span class=p>)</span><span class=c1>//如果使用了GZip则先解压</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>using</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>Stream</span> <span class=n>streamReceive</span> <span class=p>=</span> <span class=n>webResponse</span><span class=p>.</span><span class=n>GetResponseStream</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>zipStream</span> <span class=p>=</span> <span class=k>new</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>Compression</span><span class=p>.</span><span class=n>GZipStream</span><span class=p>(</span><span class=n>streamReceive</span><span class=p>,</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>Compression</span><span class=p>.</span><span class=n>CompressionMode</span><span class=p>.</span><span class=n>Decompress</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>//匹配编码格式</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=n>regex</span><span class=p>.</span><span class=n>IsMatch</span><span class=p>(</span><span class=n>contentype</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                            <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>Encoding</span> <span class=n>ending</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>GetEncoding</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=n>regex</span><span class=p>.</span><span class=n>Match</span><span class=p>(</span><span class=n>contentype</span><span class=p>).</span><span class=n>Groups</span><span class=p>[</span><span class=m>1</span><span class=p>].</span><span class=n>Value</span><span class=p>.</span><span class=n>Trim</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                                <span class=k>using</span> <span class=p>(</span><span class=n>StreamReader</span> <span class=n>sr</span> <span class=p>=</span> <span class=k>new</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>StreamReader</span><span class=p>(</span><span class=n>zipStream</span><span class=p>,</span> <span class=n>ending</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>htmlCode</span> <span class=p>=</span> <span class=n>sr</span><span class=p>.</span><span class=n>ReadToEnd</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=k>else</span>
</span></span><span class=line><span class=cl>                            <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=k>using</span> <span class=p>(</span><span class=n>StreamReader</span> <span class=n>sr</span> <span class=p>=</span> <span class=k>new</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>StreamReader</span><span class=p>(</span><span class=n>zipStream</span><span class=p>,</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>htmlCode</span> <span class=p>=</span> <span class=n>sr</span><span class=p>.</span><span class=n>ReadToEnd</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>using</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>Stream</span> <span class=n>streamReceive</span> <span class=p>=</span> <span class=n>webResponse</span><span class=p>.</span><span class=n>GetResponseStream</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>var</span> <span class=n>encoding</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>Default</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=n>contentype</span><span class=p>.</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;utf&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                            <span class=n>encoding</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>using</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>StreamReader</span> <span class=n>sr</span> <span class=p>=</span> <span class=k>new</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>StreamReader</span><span class=p>(</span><span class=n>streamReceive</span><span class=p>,</span> <span class=n>encoding</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>htmlCode</span> <span class=p>=</span> <span class=n>sr</span><span class=p>.</span><span class=n>ReadToEnd</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>htmlCode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>ex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>PS：这里要注意缓存一下_ticket（即access_token），照微信文档说的，access_token两个小时内有效，不需要频繁调用。而且获取access_token的接口有调用次数的限制，如果超过了次数，就不允许调用了。</p><p>PPS:建议noncestr和URL由前台传入比较适合，使用 var theWebUrl = window.location.href.split(&rsquo;#&rsquo;)[0] 获取URL，noncestr就随意了。</p><p>PPPS:遇到诡异的invalid signature的时候，首先检查url参数，然后检查noncestr，再不行重启一下程序获取一个新的token回来继续玩。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/.net/>.Net</a>
<a href=/tags/javascript/>Javascript</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><script src=https://utteranc.es/client.js repo=liguobao/liguobao.github.io issue-term=title crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 人生删除指南</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>